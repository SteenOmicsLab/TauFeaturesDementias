---
title: "Figure 1 Panel B,C,D PTM cumulative overview (and Supplementary Figure S3)"
author: "Christoph N. Schlaffner"
output:
  pdf_document: default
  html_document: default
---
```{r, include=FALSE}

options(stringsAsFactors = FALSE)
library(reshape2)
library(ggplot2)
library(scales)
library(ggpubr)
library(grid)
library(gridExtra)
library(ggh4x)

filter <- function(data,disease,threshold,name,direction) {
  x1 <- which(data$Neuropathology==disease)
  x2 <- x1
  if(direction=="lower") {
    x2 <- which(data[,c(name)]<=threshold)
  } else if(direction=="higher") {
    x2 <- which(data[,c(name)]>=threshold)
  }
  x <- x1[x1%in%x2]
  return(data[-x,])
}


math_format2 <- function (expr = 10^.x, expr2 = .x, format = force) {
  
  .x <- NULL
  quoted <- substitute(expr)
  subs <- function(x) {
    do.call("substitute", list(quoted, list(.x = x)))
  }
  quoted2 <- substitute(expr2)
  subs2 <- function(x) {
    do.call("substitute", list(quoted2, list(.x = x)))
  }
  function(x) {
    x[x==1] <- 10
    x[x==0] <- 1
    x <- format(x)
    ret <- lapply(x, subs)
    ret <- as.expression(ret)
    ret[is.na(x)] <- NA
    names(ret) <- names(x)
    ret2 <- lapply(x, subs2)
    ret2 <- as.expression(ret2)
    ret2[is.na(x)] <- NA
    names(ret2) <- names(x)
    ret[x%in%c(1,10)] <- ret2[x%in%c(1,10)]
    ret
  }
  
}

linesize <- 0.8

anno_colors <- list(
  NPDX1=c(fAD="#9C0B0C",AD="#E41A1C",CBD="#FFD92F",CTE="#1740B6",CTR="#4DAF4A",DLB="#8DD3C7",PiD="#984EA3",PSP="#FF7F00","#FFFFFF"))
testmethod <- "t.test"
pvaluecorrection <- "fdr"
p.label <- "p={p.adj}"
pvalsize.pval <- 6
astersize <- 6
pvalsize <- pvalsize.pval

titlesize <- 20
axistitlesize <- 16
axistextsize <- 16

outfilename <- "Figure1PanelsBCD.pdf"

file_FLEXI.absolute <- "FLEXITau_INSOL_isoform_absolutequant.csv"
file_FLEXI.tims.R <- "MSFragger_INSOL_3R-4R_FLEXITauPeptides.csv"
file_FLEXI <- "FLEXITau_INSOL_Primary_reformat_combine_reduced.csv"

data_FLEXI.absolute <- read.table(file_FLEXI.absolute,sep=",",header=FALSE)
data_FLEXI.absolute <- data_FLEXI.absolute[(data_FLEXI.absolute$V3!=""),]
data_FLEXI.absolute[data_FLEXI.absolute$V2%in%c("CTRL"),]$V2 <- "CTR"

data_FLEXI.total <- data_FLEXI.absolute[-c(2,3),c(1,2,3)]
colnames(data_FLEXI.total) <- data_FLEXI.total[1,]
data_FLEXI.total <- data_FLEXI.total[-1,]
data_FLEXI.total$TotalTau <- as.numeric(data_FLEXI.total$TotalTau)
data_FLEXI.total$Neuropathology <- factor(data_FLEXI.total$Neuropathology,levels=c("CTR","DLB","PSP","PiD","CBD","CTE","fAD","AD"))
data_FLEXI.total.remove <- aggregate(data_FLEXI.total$TotalTau,by=list(data_FLEXI.total$Neuropathology),function(x){sum(is.na(x))+sum(!is.na(x))})
data_FLEXI.total.remove <- data_FLEXI.total.remove[data_FLEXI.total.remove$x<2,]
data_FLEXI.total.test <- data_FLEXI.total
data_FLEXI.total.remove$Group.1 <- as.character(data_FLEXI.total.remove$Group.1)
data_FLEXI.total.test$Neuropathology <- as.character(data_FLEXI.total.test$Neuropathology)
if(dim(data_FLEXI.total.remove)[1]>0) {
  for(i in 1:dim(data_FLEXI.total.remove)[1]) {
    data_FLEXI.total.test <- data_FLEXI.total.test[!(data_FLEXI.total.test$Neuropathology==data_FLEXI.total.remove[i,]$Group.1),]
  }
}
totaltau_insoluble_ttest <- compare_means(TotalTau~Neuropathology,data=data_FLEXI.total.test,ref.group="CTR",method=testmethod,p.adjust.method=pvaluecorrection)

heights.total <- c(4,3.55,3.7,3.85,3.4)
heights.total <- c(4.8,3.6,4,4.4,3.2)
plot_total_insoluble <- ggplot(data_FLEXI.total,aes(x=Neuropathology,y=TotalTau)) + 
  stat_boxplot(geom="errorbar",width=linesize) +
  geom_boxplot(aes(fill=Neuropathology),lwd=linesize) +
  ggtitle(" \nTotal Tau") +
  scale_fill_manual(values=anno_colors$NPDX1) +
  scale_y_log10(sec.axis=dup_axis(label=NULL,name=""),limits=c(NA,100000),breaks=trans_breaks("log10",function(x) 10^x),labels=trans_format("log10",math_format2(10^.x)),name="absolute amount of\ninsoluble Tau [fmol/mg]") + 
  annotation_logticks(side="l",short=unit(0.15,"cm"),mid=unit(0.15,"cm"),long=unit(0.25,"cm"),linewidth=linesize) +
  annotation_logticks(side="r",short=unit(0.15,"cm"),mid=unit(0.15,"cm"),long=unit(0.25,"cm"),linewidth=linesize) +
  stat_pvalue_manual(totaltau_insoluble_ttest,label=p.label,y.position=heights.total,hide.ns=TRUE,tip.length=0,bracket.size=linesize,label.size=pvalsize) +
  theme_minimal() +
  theme(plot.title=element_text(hjust=0.5,size=titlesize,face="bold"),axis.line=element_line(size=linesize),title=element_text(size=titlesize,face="bold"),axis.ticks=element_line(size=linesize+0.1),axis.title.x=element_blank(),axis.text=element_text(size=axistextsize,face="bold",color="black"),axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),axis.title.y=element_text(size=axistitlesize,face="bold"),legend.position="none")



data_FLEXI <- read.table(file_FLEXI,sep=",",header=FALSE)
data_FLEXI <- data_FLEXI[(data_FLEXI$V3!=""),]
data_FLEXI[data_FLEXI$V2%in%c("CTRL"),]$V2 <- "CTR"
data_FLEXI.iso <- data_FLEXI[,-which(colnames(data_FLEXI)%in%c("V3","V4"))]
data_FLEXI.tmp <- as.data.frame(t(data_FLEXI.iso[c(1,2),]))
colnames(data_FLEXI.tmp) <- c("variable","Isoform")
data_FLEXI.tmp <- data_FLEXI.tmp[data_FLEXI.tmp$Isoform!="",]
data_FLEXI.tmp$Isoform <- matrix(unlist(lapply(data_FLEXI.tmp$Isoform,function(x) { strsplit(x,"@")})),ncol=2,byrow=TRUE)[,1]
data_FLEXI.tmp[data_FLEXI.tmp$Isoform=="4R*",]$Isoform <- "4R"
data_FLEXI.tmp[data_FLEXI.tmp$Isoform=="2N4R",]$Isoform <- NA
data_FLEXI.tmp <- data_FLEXI.tmp[!is.na(data_FLEXI.tmp$Isoform),]
colnames(data_FLEXI.iso) <- data_FLEXI.iso[1,]
data_FLEXI.iso <- data_FLEXI.iso[-c(1,2,3),]
data_FLEXI.iso <- melt(data_FLEXI.iso,id.vars=c("ID","Neuropathology"))
data_FLEXI.iso <- merge(data_FLEXI.iso,data_FLEXI.tmp,by=c("variable"))
data_FLEXI.iso$value <- as.numeric(data_FLEXI.iso$value)
data_FLEXI.iso <- data_FLEXI.iso[!is.na(data_FLEXI.iso$value),]
data_FLEXI.iso <- data_FLEXI.iso[data_FLEXI.iso$Isoform%in%c("0N","1N","2N","3R","4R"),]
data_FLEXI.iso$Neuropathology <- factor(data_FLEXI.iso$Neuropathology,levels=c("CTR","DLB","PSP","PiD","CBD","CTE","fAD","AD"))

data_FLEXI.iso.N <- data_FLEXI.iso[data_FLEXI.iso$Isoform%in%c("0N","1N","2N"),]
data_FLEXI.iso.N$Isoform <- factor(data_FLEXI.iso.N$Isoform,levels=c("2N","1N","0N"))
data_FLEXI.iso.N.remove <- aggregate(data_FLEXI.iso.N$value,by=list(data_FLEXI.iso.N$Neuropathology,data_FLEXI.iso.N$Isoform),function(x){sum(is.na(x))+sum(!is.na(x))})
data_FLEXI.iso.N.remove <- data_FLEXI.iso.N.remove[data_FLEXI.iso.N.remove$x<2,]
data_FLEXI.iso.N.test <- data_FLEXI.iso.N
data_FLEXI.iso.N.remove$Group.1 <- as.character(data_FLEXI.iso.N.remove$Group.1)
data_FLEXI.iso.N.remove$Group.2 <- as.character(data_FLEXI.iso.N.remove$Group.2)
data_FLEXI.iso.N.test$Neuropathology <- as.character(data_FLEXI.iso.N.test$Neuropathology)
data_FLEXI.iso.N.test$Isoform <- as.character(data_FLEXI.iso.N.test$Isoform)
for(i in 1:dim(data_FLEXI.iso.N.remove)[1]) {
  data_FLEXI.iso.N.test <- data_FLEXI.iso.N.test[!(data_FLEXI.iso.N.test$Neuropathology==data_FLEXI.iso.N.remove[i,]$Group.1&data_FLEXI.iso.N.test$Isoform==data_FLEXI.iso.N.remove[i,]$Group.2),]
}

data_FLEXI.iso.N.test$Neuropathology <- factor(data_FLEXI.iso.N.test$Neuropathology,levels=c("CTR","DLB","PSP","PiD","CBD","CTE","fAD","AD"))
data_FLEXI.iso.N.test$Isoform <- factor(data_FLEXI.iso.N.test$Isoform,levels=c("2N","1N","0N"))
Nisoform_insoluble_ttest <- compare_means(value~Isoform,data=data_FLEXI.iso.N.test,group.by=c("Neuropathology"),method=testmethod,p.adjust.method=pvaluecorrection)
data_FLEXI.iso.N.mean <- aggregate(data_FLEXI.iso.N$value,by=list(data_FLEXI.iso.N$Neuropathology,data_FLEXI.iso.N$Isoform),na.action=na.pass,mean,na.rm=TRUE)
colnames(data_FLEXI.iso.N.mean) <- c("Neuropathology","Isoform","mean")
data_FLEXI.iso.N.sd <- aggregate(data_FLEXI.iso.N$value,by=list(data_FLEXI.iso.N$Neuropathology,data_FLEXI.iso.N$Isoform),sd,na.rm=TRUE)
colnames(data_FLEXI.iso.N.sd) <- c("Neuropathology","Isoform","sd")
data_FLEXI.iso.N.tmp <- merge(data_FLEXI.iso.N.mean,data_FLEXI.iso.N.sd)
data_FLEXI.iso.N.tmp[is.na(data_FLEXI.iso.N.tmp$sd),]$sd <- 0.000001
data_FLEXI.iso.N.tmp$meanp3sd <- data_FLEXI.iso.N.tmp$mean + 100*data_FLEXI.iso.N.tmp$sd
data_FLEXI.iso.N.tmp$meanm3sd <- data_FLEXI.iso.N.tmp$mean - 100*data_FLEXI.iso.N.tmp$sd

isoforms <- c("2N","1N","0N")
neuropath <- c("AD","fAD","CTE","DBC","PiD","PSP","DLB","CTR")
for(i in isoforms) {
  tmp.red1 <- data_FLEXI.iso.N.tmp[data_FLEXI.iso.N.tmp$Isoform==i,]
  for(j in neuropath) {
    tmp.red <- tmp.red1[tmp.red1$Neuropathology==j,]
    
    if(sum((data_FLEXI.iso.N$Isoform==i&data_FLEXI.iso.N$Neuropathology==j)&(data_FLEXI.iso.N$value<tmp.red$meanm3sd|data_FLEXI.iso.N$value>tmp.red$meanp3sd))>0) {
      data_FLEXI.iso.N[(data_FLEXI.iso.N$Isoform==i&data_FLEXI.iso.N$Neuropathology==j)&(data_FLEXI.iso.N$value<tmp.red$meanm3sd|data_FLEXI.iso.N$value>tmp.red$meanp3sd),]$value <- NA
    }
  }
}
data_FLEXI.iso.N <- data_FLEXI.iso.N[data_FLEXI.iso.N$value>0.0,]
data_FLEXI.iso.N <- data_FLEXI.iso.N[!is.na(data_FLEXI.iso.N$value),]


logheights.N <- c(-0.6,-0.6,-0.6,-0.8,-0.6,-0.6,-0.6)
logheights.N <- c(-0.3,-0.3,-0.3,-0.7,-0.3,-0.3,-0.3)
logheights.N <- c(1.6,2.2,1.9,1.6,1.3,1.9,1.6,1.6,1.9,1.3,1.3,1.6,1.3)+0.1
regheights.N <- c(0.01,0.01,0.01,0.35,0.01,0.01,0.01)


ylabel.N <- "absolute amount of\nisoform peptide [fmol/mg]"
heights.N <- logheights.N


logticks_left <- annotation_logticks(sides='l',short=unit(0.15,"cm"),mid=unit(0.15,"cm"),long=unit(0.25,"cm"),size=linesize)
logticks_left$data <- data.frame(x=NA, Neuropathology=factor(c("CTR","DLB","PSP","PiD","CBD","CTE","fAD","AD"),levels=c("CTR","DLB","PSP","PiD","CBD","CTE","fAD","AD")))
logticks_right <- annotation_logticks(sides='r',short=unit(0.15,"cm"),mid=unit(0.15,"cm"),long=unit(0.25,"cm"),size=linesize)
logticks_right$data <- data.frame(x=NA, Neuropathology=factor(c("CTR","DLB","PSP","PiD","CBD","CTE","fAD","AD"),levels=c("CTR","DLB","PSP","PiD","CBD","CTE","fAD","AD")))

math_function3 <- function(x) {
  x <- x[round(x,0)==x]
  10^x
}


plot_N_insoluble <- ggplot(data_FLEXI.iso.N,aes(x=Isoform,y=value)) + 
  stat_boxplot(geom="errorbar",width=linesize) +
  geom_boxplot(aes(fill=Neuropathology),lwd=linesize) +
  facet_wrap2(~Neuropathology,ncol=11,strip.position="bottom",axes="all",remove_labels="y") +
  ggtitle("2N, 1N, 0N\n(exon 2-3 splicing)") +
  scale_fill_manual(values=anno_colors$NPDX1) +
  scale_y_log10(sec.axis=dup_axis(label=NULL,name=""),limits=c(NA,225),breaks=trans_breaks("log10",math_function3),labels=trans_format("log10",math_format2(10^.x)),name=ylabel.N) + 
  logticks_left + logticks_right +
  stat_pvalue_manual(Nisoform_insoluble_ttest,label=p.label,y.position=heights.N,hide.ns=TRUE,tip.length=0,bracket.size=linesize,label.size=pvalsize) +
  theme_minimal() +
  theme(plot.title=element_text(hjust=0.5,size=titlesize,face="bold"),axis.line=element_line(size=linesize),strip.placement="outside",panel.spacing=unit(0,"mm"),strip.text=element_text(size=axistextsize,face="bold"),title=element_text(size=titlesize,face="bold"),axis.ticks=element_line(size=linesize+0.1),axis.title.x=element_blank(),axis.text=element_text(size=axistextsize,face="bold",color="black"),axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),axis.title.y=element_text(size=axistitlesize,face="bold"),legend.position="none")

timsdata.flexi <- read.csv(file_FLEXI.tims.R,header=TRUE)
timsdata.flexi <- timsdata.flexi[,c("Sample","NPDX","X3R4R")]
colnames(timsdata.flexi) <- c("ID","Neuropathology","RisoformRatio")
timsdata.flexi[timsdata.flexi$Neuropathology=="CTRL",]$Neuropathology <- "CTR"

timsdata.flexi$Neuropathology <- factor(timsdata.flexi$Neuropathology,levels=c("CTR","DLB","PSP","PiD","CBD","CTE","fAD","AD"))

Rratio2_timsdata_ttest <- compare_means(RisoformRatio~Neuropathology,data=timsdata.flexi,ref.group="CTR",method=testmethod,p.adjust.method=pvaluecorrection)

logheights.R <- c(1.8,2,2.2,2.4,2.6)
logheights.R <- c(1.6,2.1,2.6,3.1,3.6)
logheights.R <- c(0.55,0.9,1.25,1.6)
regheights.R <- c(82.5,87.5,92.5,97.5,102.5)
ylabel.R <- "ratio [3R/4R]"
heights.R <- logheights.R
plot_R_timsdata <- ggplot(timsdata.flexi,aes(x=Neuropathology,y=RisoformRatio)) + 
  geom_hline(yintercept=1, linetype="dashed", color = "darkgrey") +
  stat_boxplot(geom="errorbar",width=linesize) +
  geom_boxplot(aes(fill=Neuropathology),lwd=linesize) +
  ggtitle("3R/4R ratio\n(exon 10 splicing)") +
  scale_fill_manual(values=anno_colors$NPDX1) +
  scale_y_log10(sec.axis=dup_axis(label=NULL,name=""),limits=c(NA,80),breaks=trans_breaks("log10",function(x){print(x); 10^x}),labels=trans_format("log10",math_format2(10^.x)),name=ylabel.R) + 
  annotation_logticks(side="l",short=unit(0.15,"cm"),mid=unit(0.15,"cm"),long=unit(0.25,"cm"),size=linesize) +
  annotation_logticks(side="r",short=unit(0.15,"cm"),mid=unit(0.15,"cm"),long=unit(0.25,"cm"),size=linesize) +
  stat_pvalue_manual(Rratio2_timsdata_ttest,label=p.label,y.position=heights.R,hide.ns=TRUE,tip.length=0,bracket.size=linesize,label.size=pvalsize) +
  theme_minimal() +
  theme(plot.title=element_text(hjust=0.5,size=titlesize,face="bold"),axis.line=element_line(size=linesize),title=element_text(size=titlesize,face="bold"),axis.ticks=element_line(size=linesize+0.1),axis.title.x=element_blank(),axis.text=element_text(size=axistextsize,face="bold",color="black"),axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),axis.title.y=element_text(size=axistitlesize,face="bold"),legend.position="none")

labelsize <- 22
layout <- t(cbind(c(1,1,1,2,2,2),
                c(1,1,1,2,2,2),
                c(3,3,3,3,3,3),
                c(3,3,3,3,3,3)))

p_all <- grid.arrange(grobs=list(plot_total_insoluble,plot_R_timsdata,plot_N_insoluble),layout_matrix=layout)
ggsave(outfilename,p_all,device="pdf",width=8.32,height=5.12,units="in",scale=2)
```