---
title: "Figure 5 Panel E Summary of top important features of RF classifiers"
author: "Christoph N. Schlaffner"
output:
  pdf_document: default
  html_document: default
---
```{r, include=FALSE}
options(stringsAsFactors = FALSE)
library(ggplot2)
library(R.utils)
library(reshape2)
library(circlize)
library(gridExtra)
library(ggpubr)
library(stringr)
library(ggnewscale)
library(ggrepel)

substitueSeparators <- function(x) {
  str_replace_all(str_replace_all(str_replace_all(str_replace_all(x,"@","."),"\\(","."),"\\)","."),"; ","..")
}

substitueSeparators2 <- function(x) {
  str_replace_all(str_replace_all(str_replace_all(str_replace_all(str_replace_all(str_replace_all(x,"@","."),"\\(","."),"\\)","."),"; ",".."),"Non-tryptic","Nontryptic"),"\\-",".")
}

custommean <- function(x) {
  x <- as.numeric(x)
  mean(x)
}

custommean2 <- function(x) {
  x <- as.numeric(x)
  y <- mean(x,na.rm=TRUE)
  if(is.nan(y)) {
    y <- NA
  }
  y
}

splitPTMs <- function(x) {
  x_split <- unlist(strsplit(x,"_"))
  isoform <- x_split[length(x_split)]
  x <- str_replace_all(x,paste("_",isoform,sep=""),"")
  x <- substitueSeparators(x)
  x_split <- strsplit(x,"\\.")
  y <- unlist(x_split)[nchar(unlist(x_split))>=1|!is.na(as.numeric(unlist(x_split)))]
  idxs <- (which(!is.na(as.numeric(y)))+1)
  
  y <- insert(y,idxs,values=rep(x,length(which(!is.na(as.numeric(y))))))
  extseq <- seq(0,length(idxs)-1,by=1)
  idxs <- idxs + extseq + 1
  insert(y,idxs,values=rep(isoform,length(which(!is.na(as.numeric(y))))))
}

splitCleavages <- function(x) {
  x_split <- unlist(strsplit(x,"_"))
  isoform <- x_split[length(x_split)]
  x <- str_replace_all(x,paste("_",isoform,sep=""),"")
  x <- substitueSeparators2(x)
  x_split <- strsplit(x,"\\.")
  y <- unlist(x_split)[nchar(unlist(x_split))>=1|!is.na(as.numeric(unlist(x_split)))]
  idxs <- (which(!is.na(as.numeric(y)))+1)

  y <- insert(y,idxs,values=rep(x,length(which(!is.na(as.numeric(y))))))
  extseq <- seq(0,length(idxs)-1,by=1)
  idxs <- idxs + extseq + 1
  insert(y,idxs,values=rep(isoform,length(which(!is.na(as.numeric(y))))))
}

splitFLEXI <- function(x) {
  x_split <- unlist(strsplit(x,"_"))
  peptide <- x_split[length(x_split)]
  x <- str_replace_all(x,paste("_",peptide,sep=""),"")
  x <- substitueSeparators2(x)
  x_split <- strsplit(x,"\\.")
  y <- unlist(x_split)[nchar(unlist(x_split))>=1|!is.na(as.numeric(unlist(x_split)))]
  idxs <- (which(!is.na(as.numeric(y)))+1)
  y <- insert(y,idxs[length(idxs)],values=c(x))
  if(length(idxs)==1) {
    y <- insert(y,idxs[length(idxs)],values=y[idxs[length(idxs)]-1])
  }
  c(peptide,y[c(2,3)],paste(paste(y[1],y[2],y[3],sep="."),peptide,sep="_"),y[1])
}

splitFLEXI2 <- function(x) {
  x_split <- unlist(strsplit(x,"_"))
  peptide <- x_split[length(x_split)]
  x <- str_replace_all(x,paste("_",peptide,sep=""),"")
  x <- substitueSeparators2(x)
  x_split <- strsplit(x,"\\.")
  y <- unlist(x_split)[nchar(unlist(x_split))>=1|!is.na(as.numeric(unlist(x_split)))]
  idxs <- (which(!is.na(as.numeric(y)))+1)
  y <- insert(y,idxs[length(idxs)],values=c(x))
  if(length(idxs)==1) {
    y <- insert(y,idxs[length(idxs)],values=y[idxs[length(idxs)]-1])
  }
  c(peptide,y)
}

adjustheights <- function(df_tmp,d,s,direction) {
  idxs1 <- df_tmp$V3
  idxs1_1 <- c(1,idxs1[1:(length(idxs1)-1)])
  
  addition <- c()
  if(length(idxs1)>0) {
    for(i in 1:length(idxs1)) {
      if(i==1) {
        addition <- c(addition,0)
      } else if(i==length(idxs1)) {
        if(addition[length(addition)]!=0) {
          addition <- c(addition,addition[length(addition)]+s)
        } else {
          addition <- c(addition,0)
        }
      } else {
        if(idxs1[i]>idxs1[i-1]+d) {
          addition <- c(addition,0)
        } else {
          addition <- c(addition,addition[length(addition)]+s)
        }
      }
    }
    df_tmp$V4 <- df_tmp$V4+(direction*addition)
  }
  df_tmp
}

adjustheights_all <- function(df_tmp,d,s,nophospho=FALSE) {
  if(nophospho==TRUE) {
    df_tmp2 <- df_tmp
    df_tmp2 <- df_tmp2[order(df_tmp2$V3),]
    df_tmp2 <- adjustheights(df_tmp2,d,s,-1)
    df_tmp <- df_tmp2[order(df_tmp2$V3),]
  } else {
    df_tmp1 <- df_tmp[df_tmp$V1%in%c("Phospho"),]
    df_tmp1 <- df_tmp1[order(df_tmp1$V3),]
    df_tmp2 <- df_tmp[!(df_tmp$V1%in%c("Phospho")),]
    df_tmp2 <- df_tmp2[order(df_tmp2$V3),]
    
    df_tmp1 <- adjustheights(df_tmp1,d,s,1)
    df_tmp2 <- adjustheights(df_tmp2,d,s,-1)
    
    df_tmp <- rbind(df_tmp1,df_tmp2)
    df_tmp <- df_tmp[order(df_tmp$V3),]
  }
  df_tmp
}

readjust_reverse <- function(df_tmp,s,min_v) {
  fliplabel <- rep(1,dim(df_tmp)[1])
  values <- df_tmp$V4 - min_v
  valleys <- which(values==0.0)
  if(length(valleys)>1) {
    peaklengths <- c(valleys[2:length(valleys)],length(values)+1)-valleys
  } else {
    peaklengths <- c(length(values)+1)-valleys
  }
  peaklengths_idxs <- peaklengths>2
  peaklengths <- peaklengths[peaklengths_idxs]
  valleys <- valleys[peaklengths_idxs]
  offset <- ceiling(peaklengths/2)
  run <- peaklengths-ceiling(peaklengths/2)
  if(length(valleys)>0) {
    for(i in 1:length(valleys)) {
      count <- run[i]
      while(count>0) {
        if(count!=run[i] || peaklengths[i]%%2!=0) {
          df_tmp$V4[valleys[i]+offset[i]+(run[i]-count)] <- df_tmp$V4[valleys[i]+offset[i]+(run[i]-count)-1] - s
          fliplabel[valleys[i]+offset[i]+(run[i]-count)] <- -1
        }
        count <- count - 1
      }
    }
  }
  df_tmp$V6 <- fliplabel
  df_tmp
}

readjust_reverse_all <- function(df_tmp,s,min_v,nophospho=FALSE) {
  if(nophospho==TRUE) {
    df_tmp2 <- df_tmp
    df_tmp2 <- df_tmp2[order(df_tmp2$V3),]
    df_tmp2 <- readjust_reverse(df_tmp2,-1*s,-1*min_v)
    df_tmp <- df_tmp2[order(df_tmp2$V3),]
  } else {
    df_tmp1 <- df_tmp[df_tmp$V1%in%c("Phospho"),]
    df_tmp1 <- df_tmp1[order(df_tmp1$V3),]
    df_tmp2 <- df_tmp[!(df_tmp$V1%in%c("Phospho")),]
    df_tmp2 <- df_tmp2[order(df_tmp2$V3),]
    
    df_tmp1 <- readjust_reverse(df_tmp1,s,min_v)
    df_tmp2 <- readjust_reverse(df_tmp2,-1*s,-1*min_v)
    
    df_tmp <- rbind(df_tmp1,df_tmp2)
    df_tmp <- df_tmp[order(df_tmp$V3),]
  }
  df_tmp
}


createFigure1 <- function(infile,infileC,infileF,fileout,min_value,threshold,threshold2,inpfileP,inpfileC,inpfileF) {
  
  indata <- read.csv(infile,header=FALSE)
  indataC <- read.csv(infileC,header=FALSE)
  indataF <- read.csv(infileF,header=FALSE)
  
  if(any(indata$V2=="CTRL")) {
    indata[indata$V2=="CTRL",]$V2 <- "CTR"
  }
  indata[indata$V2=="fAD",]$V2 <- "AD"
  indata[indata$V2=="DLB",]$V2 <- "CTR"
  if(any(indataC$V2=="CTRL")) {
    indataC[indataC$V2=="CTRL",]$V2 <- "CTR"
  }
  indataC[indataC$V2=="fAD",]$V2 <- "AD"
  indataC[indataC$V2=="DLB",]$V2 <- "CTR"
  if(any(indataF$V2=="CTRL")) {
    indataF[indataF$V2=="CTRL",]$V2 <- "CTR"
  }
  indataF[indataF$V2=="fAD",]$V2 <- "AD"
  indataF[indataF$V2=="DLB",]$V2 <- "CTR"

  indataF <- indataF[-c(2),]
  indataF[1,c(1,2,3,4)] <- c("","","TotalTau","Ratio")
  
  indata.dup <- indata[2,t(duplicated(t(indata[c(2),])))]
  indata.dup <- indata.dup[1,indata.dup[1,]!=""]
  indataC.dup <- indataC[2,t(duplicated(t(indataC[c(2),])))]
  indataC.dup <- indataC.dup[1,indataC.dup[1,]!=""]
  
  indata[c(1),indata[c(2),]%in%indata.dup[c(1),]] <- "2N4R"
  indataC[c(1),indataC[c(2),]%in%indataC.dup] <- "2N4R"
  
  indata <- cbind(indata[,c(1,2)],as.data.frame(t(aggregate(. ~ V1+V2,data=as.data.frame(t(indata[,-c(1,2)])),function(x){y <- as.numeric(x); y <- sum(y); if(y>0) {y<-1} else {y<-0}; y}))))
  indataC <- cbind(indataC[,c(1,2)],as.data.frame(t(aggregate(. ~ V1+V2,data=as.data.frame(t(indataC[,-c(1,2)])),function(x){y <- as.numeric(x); y <- mean(y); y}))))
  
  colnames(indata) <- paste("V",1:dim(indata)[2],sep="")
  colnames(indataC) <- paste("V",1:dim(indataC)[2],sep="")
  colnames(indataF) <- paste("V",1:dim(indataF)[2],sep="")
  
  columnnames <- colnames(as.matrix(indata[-c(1,2),-c(1,2)]))
  filterm <- matrix(as.numeric(as.matrix(indata[-c(1,2),-c(1,2)])),byrow=FALSE,ncol=length(columnnames))
  filtersums <- colSums(filterm)
  indata <- indata[,c(TRUE,TRUE,filtersums>=1)]
  
  columnnamesC <- colnames(as.matrix(indataC[-c(1,2),-c(1,2)]))
  filtermC <- matrix(as.numeric(as.matrix(indataC[-c(1,2),-c(1,2)])),byrow=FALSE,ncol=length(columnnamesC))
  filtersumsC <- colSums(filtermC)
  indataC <- indataC[,c(TRUE,TRUE,filtersumsC>=1)]
  
  columnnamesF <- colnames(as.matrix(indataF[-c(1,2),-c(1,2)]))
  filtermF <- matrix(as.numeric(as.matrix(indataF[-c(1,2),-c(1,2)])),byrow=FALSE,ncol=length(columnnamesF))
  filtersumsF <- colSums(filtermF,na.rm=TRUE)
  indataF <- indataF[,c(TRUE,TRUE,filtersumsF>0)]
  
  indata <- indata[,!((indata[2,]=="")&(indata[1,]!=""))]
  indataC <- indataC[,!((indataC[2,]=="")&(indataC[1,]!=""))]
  indataF <- indataF[,!((indataF[2,]=="")&(indataF[1,]!=""))]

  PTMsites <- indata[2,-c(1,2)]
  Isosites <- indata[1,-c(1,2)]
  PTMsites <- paste(PTMsites,Isosites,sep="_")
  
  Cleavagesites <- indataC[2,-c(1,2)]
  Isosites <- indataC[1,-c(1,2)]
  Cleavagesites <- paste(Cleavagesites,Isosites,sep="_")
  
  FLEXIsites <- indataF[2,-c(1,2)]
  
  df <- as.data.frame(matrix(unlist(lapply(PTMsites,splitPTMs)),ncol=5,byrow=TRUE))
  dfC <- as.data.frame(matrix(unlist(lapply(Cleavagesites,splitCleavages)),ncol=5,byrow=TRUE))
  dfF <- as.data.frame(matrix(unlist(lapply(FLEXIsites,splitFLEXI)),ncol=5,byrow=TRUE))
  
  df.full <- df
  df <- df[,c(1:3,5)]
  df$V6 <- paste(df$V2,df$V3,sep="")
  df$V0 <- paste(df$V1,"(",df$V2,")@",df$V3,sep="")
  df$V01 <- df$V0
  df$V3 <- as.numeric(df$V3)
  
  dfC.full <- dfC
  dfC <- dfC[,c(1:3,5)]
  dfC$V6 <- paste(dfC$V2,dfC$V3,sep="")
  dfC$V0 <- paste(dfC$V1,"(",dfC$V2,")@",dfC$V3,sep="")
  dfC$V01 <- dfC$V0
  dfC$V3 <- as.numeric(dfC$V3)
  
  dfF.full <- dfF
  dfF <- dfF[,c(1:3,5)]
  dfF$V6 <- paste(dfF$V2,"-",dfF$V3,sep="")
  dfF$V0 <- paste(dfF$V1,"@",dfF$V2,"-",dfF$V3,sep="")
  dfF$V01 <- dfF$V0
  dfF$V2 <- as.numeric(dfF$V2)
  dfF$V3 <- as.numeric(dfF$V3)
  
  originalcols <- data.frame(PTM=c("ID","Neuropathology",substitueSeparators(indata[2,-c(1,2)])),iso=c("ID","Neuropathology",substitueSeparators(indata[1,-c(1,2)])),idx=seq(1,dim(indata)[2],by=1))
  org <- c(1,2)
  maxlength <- dim(df.full)[1]
  for(i in 1:maxlength) {
    tmp <- originalcols[which(originalcols$PTM==df.full$V4[i]),]
    tmp <- tmp[tmp$iso==df.full$V5[i],]
    org <- c(org,tmp$idx)
  }
  
  originalcols <- data.frame(Cleavage=c("ID","Neuropathology",substitueSeparators2(indataC[2,-c(1,2)])),iso=c("ID","Neuropathology",substitueSeparators2(indataC[1,-c(1,2)])),idx=seq(1,dim(indataC)[2],by=1))
  orgC <- c(1,2)
  maxlength <- dim(dfC.full)[1]
  for(i in 1:maxlength) {
    tmp <- originalcols[which(originalcols$Cleavage==dfC.full$V4[i]),]
    tmp <- tmp[tmp$iso==dfC.full$V5[i],]
    orgC <- c(orgC,tmp$idx)
  }
  
  originalcols <- data.frame(FLEXI=c("ID","Neuropathology",substitueSeparators2(indataF[2,-c(1,2)])),iso=c("ID","Neuropathology",substitueSeparators2(indataF[1,-c(1,2)])),idx=seq(1,dim(indataF)[2],by=1))
  orgF <- c(1,2)
  maxlength <- dim(dfF.full)[1]
  for(i in 1:maxlength) {
    tmp <- originalcols[which(originalcols$FLEXI==dfF.full$V4[i]),]
    tmp <- tmp[tmp$iso==dfF.full$V1[i],]
    orgF <- c(orgF,tmp$idx)
  }

  indata2 <- indata[,org]
  colnames(indata2) <- c("ID","Neuropathology",df$V01)
  indata.tmp <- as.data.frame(cbind(matrix(c("","","","","",""),ncol=2),t(df[,c("V1","V6","V5")])))
  colnames(indata.tmp) <- colnames(indata2)
  indata2 <- as.data.frame(t(rbind(indata.tmp,indata2)))
  indata2.head <- indata2[c(1,2),]
  indata2 <- indata2[-c(1,2),]
  
  indataC2 <- indataC[,orgC]
  colnames(indataC2) <- c("ID","Neuropathology",dfC$V01)
  indataC.tmp <- as.data.frame(cbind(matrix(c("","","","","",""),ncol=2),t(dfC[,c("V1","V6","V5")])))
  colnames(indataC.tmp) <- colnames(indataC2)
  indataC2 <- as.data.frame(t(rbind(indataC.tmp,indataC2)))
  indataC2.head <- indataC2[c(1,2),]
  indataC2 <- indataC2[-c(1,2),]
  
  indataF2 <- indataF[,orgF]
  colnames(indataF2) <- c("ID","Neuropathology",dfF$V01)
  indataF.tmp <- as.data.frame(cbind(matrix(c("","","","","",""),ncol=2),t(dfF[,c("V1","V6","V5")])))
  colnames(indataF.tmp) <- colnames(indataF2)
  indataF2 <- as.data.frame(t(rbind(indataF.tmp,indataF2)))
  indataF2.head <- indataF2[c(1,2),]
  indataF2 <- indataF2[-c(1,2),]
  
  indata2 <- indata2[,-c(3,4,5)]
  indata2.head <- indata2.head[,-c(3,4,5)]
  indata2 <- aggregate(. ~ V1+V6,data=indata2,max,na.rm=TRUE)
  df$V01 <- NULL
  df$V5 <- NULL
  df <- df[!duplicated(df),]
  
  indataC2 <- indataC2[,-c(3,4,5)]
  indataC2.head <- indataC2.head[,-c(3,4,5)]
  indataC2 <- aggregate(. ~ V1+V6,data=indataC2,custommean)
  dfC$V01 <- NULL
  dfC$V5 <- NULL
  dfC <- dfC[!duplicated(dfC),]
  
  indataF2 <- indataF2[,-c(3,4,5)]
  indataF2.head <- indataF2.head[,-c(3,4,5)]
  indataF2 <- aggregate(. ~ V1+V6,data=indataF2,na.action=na.pass,custommean2)
  dfF$V01 <- NULL
  dfF$V5 <- NULL
  dfF <- dfF[!duplicated(dfF),]
  
  indata2 <- merge(df,indata2,all=TRUE,by=c("V1","V6"))
  indata2$V3.x <- as.numeric(indata2$V3.x)
  indata2 <- indata2[order(indata2$V3.x,indata2$V1),]
  indata2$V2 <- NULL
  indata2$V3.x <- NULL
  rownames(indata2) <- indata2$V0
  indata2$V0 <- NULL
  colnames(indata2) <- colnames(indata2.head)
  indata2 <- as.data.frame(t(rbind(indata2.head,indata2)))
  
  indataC2 <- merge(dfC,indataC2,all=TRUE,by=c("V1","V6"))
  indataC2$V3.x <- as.numeric(indataC2$V3.x)
  indataC2 <- indataC2[order(indataC2$V3.x,indataC2$V1),]
  indataC2$V2 <- NULL
  indataC2$V3.x <- NULL
  rownames(indataC2) <- indataC2$V0
  indataC2$V0 <- NULL
  colnames(indataC2) <- colnames(indataC2.head)
  indataC2 <- as.data.frame(t(rbind(indataC2.head,indataC2)))
  
  indataF2 <- merge(dfF,indataF2,all=TRUE,by=c("V1","V6"))
  indataF2$V2 <- as.numeric(indataF2$V2)
  indataF2$V3 <- as.numeric(indataF2$V3)
  indataF2 <- indataF2[order(indataF2$V2,indataF2$V3),]
  indataF2$V2 <- NULL
  indataF2$V3 <- NULL
  rownames(indataF2) <- indataF2$V0
  indataF2$V0 <- NULL
  colnames(indataF2) <- colnames(indataF2.head)
  indataF2 <- as.data.frame(t(rbind(indataF2.head,indataF2)))

  indata2.head <- indata2[c(1,2),]
  indata2.head$ID <- NULL
  indata2 <- indata2[-c(1,2),]
  rownames(indata2) <- indata2$ID
  indata2$ID <- NULL
  indata2[,-1] <- apply(indata2[,-1],2,function(x){as.numeric(x)})
  indata2 <- aggregate(.~Neuropathology,data=indata2,mean)
  indata2 <- as.data.frame(t(rbind(indata2.head,indata2)))
  indata2 <- merge(df,indata2,all=TRUE)
  colnames(indata2) <- c("modification","site","AA","seg.po",indata2[1,5:11])
  indata2 <- indata2[-1,]
  
  indataC2.head <- indataC2[c(1,2),]
  indataC2.head$ID <- NULL
  indataC2 <- indataC2[-c(1,2),]
  rownames(indataC2) <- indataC2$ID
  indataC2$ID <- NULL
  indataC2[,-1] <- apply(indataC2[,-1],2,function(x){as.numeric(x)})
  indataC2 <- aggregate(.~Neuropathology,data=indataC2,mean)
  indataC2 <- as.data.frame(t(rbind(indataC2.head,indataC2)))
  indataC2 <- merge(dfC,indataC2,all=TRUE)
  colnames(indataC2) <- c("modification","site","AA","seg.po",indataC2[1,5:11])
  indataC2 <- indataC2[-1,]
  
  indataF2.head <- indataF2[c(1,2),]
  indataF2.head$ID <- NULL
  indataF2 <- indataF2[-c(1,2),]
  rownames(indataF2) <- indataF2$ID
  indataF2$ID <- NULL
  indataF2[,-1] <- apply(indataF2[,-1],2,function(x){as.numeric(x)})
  indataF2 <- aggregate(.~Neuropathology,data=indataF2,na.action=na.pass,mean,na.rm=TRUE)
  indataF2 <- as.data.frame(t(rbind(indataF2.head,indataF2)))
  indataF2 <- merge(dfF,indataF2,all=TRUE)
  colnames(indataF2) <- c("modification","site","seg.po","seg.po.2",indataF2[1,5:11])
  indataF2 <- indataF2[-1,]

  indata2$AD <- as.numeric(indata2$AD)
  indata2$CBD <- as.numeric(indata2$CBD)
  indata2$CTR <- as.numeric(indata2$CTR)
  indata2$PiD <- as.numeric(indata2$PiD)
  indata2$PSP <- as.numeric(indata2$PSP)
  indata2$CTE <- as.numeric(indata2$CTE)
  
  indataC2$AD <- as.numeric(indataC2$AD)
  indataC2$CBD <- as.numeric(indataC2$CBD)
  indataC2$CTR <- as.numeric(indataC2$CTR)
  indataC2$PiD <- as.numeric(indataC2$PiD)
  indataC2$PSP <- as.numeric(indataC2$PSP)
  indataC2$CTE <- as.numeric(indataC2$CTE)
 
  indataF2$AD <- as.numeric(indataF2$AD)
  indataF2$CBD <- as.numeric(indataF2$CBD)
  indataF2$CTR <- as.numeric(indataF2$CTR)
  indataF2$PiD <- as.numeric(indataF2$PiD)
  indataF2$PSP <- as.numeric(indataF2$PSP)
  indataF2$CTE <- as.numeric(indataF2$CTE)

  indata2 <- indata2[,-c(5)]
  indataC2 <- indataC2[,-c(5)]
  indataF2 <- indataF2[,-c(5)]
  
  indata2 <- indata2[apply(indata2[,c(5:10)],1,sum)>0.0,]
  indata2$seg.po <- as.numeric(indata2$seg.po)
  
  indataC2 <- indataC2[apply(indataC2[,c(5:10)],1,sum)>0.0,]
  indataC2$seg.po <- as.numeric(indataC2$seg.po)
  
  indataF2 <- indataF2[apply(indataF2[,c(5:10)],1,sum,na.rm=TRUE)>0.0,]
  indataF2$seg.po <- as.numeric(indataF2$seg.po)
  indataF2$seg.po.2 <- as.numeric(indataF2$seg.po.2)
  
  seg.f <- data.frame(seg.name=c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term"),seg.Start=c(1,45,74,103,151,242,273,304,335,372),seg.End=c(44,73,102,150,241,272,303,334,371,441),the.v=c(NA),NO=c(NA))
  seg.name <- c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term")
  indata2$seg.name <- lapply(indata2$seg.po,function(x,mapping){ mapping$seg.name[which(x>= mapping$seg.Start)[which(x>=mapping$seg.Start)%in%which(x<=mapping$seg.End)]] },seg.f)
  indata2 <- indata2[,c("seg.name","AA","seg.po","CTR","PSP","PiD","CBD","CTE","AD","modification","site")]
  
  seg.f$seg.Start <- as.character(seg.f$seg.Start)
  seg.f$seg.End <- as.character(seg.f$seg.End)
  seg.annotation <- indata2[,c(1,2,10,11)]
  
  segC.f <- data.frame(seg.name=c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term"),seg.Start=c(1,45,74,103,151,242,273,304,335,372),seg.End=c(44,73,102,150,241,272,303,334,371,441),the.v=c(NA),NO=c(NA))
  segC.name <- c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term")
  indataC2$seg.name <- lapply(indataC2$seg.po,function(x,mapping){ mapping$seg.name[which(x>= mapping$seg.Start)[which(x>=mapping$seg.Start)%in%which(x<=mapping$seg.End)]] },segC.f)
  indataC2 <- indataC2[,c("seg.name","AA","seg.po","CTR","PSP","PiD","CBD","CTE","AD","modification","site")]
  segC.f$seg.Start <- as.character(segC.f$seg.Start)
  segC.f$seg.End <- as.character(segC.f$seg.End)
  segC.annotation <- indataC2[,c(1,2,10,11)]
  
  segF.f <- data.frame(seg.name=c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term"),seg.Start=c(1,45,74,103,151,242,273,304,335,372),seg.End=c(44,73,102,150,241,272,303,334,371,441),the.v=c(NA),NO=c(NA))
  segF.name <- c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term")
  indataF2$seg.name <- lapply(indataF2$seg.po,function(x,mapping){ mapping$seg.name[which(x>= mapping$seg.Start)[which(x>=mapping$seg.Start)%in%which(x<=mapping$seg.End)]] },segF.f)
  indataF2$seq.name.2 <- lapply(indataF2$seg.po.2,function(x,mapping){ mapping$seg.name[which(x>= mapping$seg.Start)[which(x>=mapping$seg.Start)%in%which(x<=mapping$seg.End)]] },segF.f)
  indataF2 <- indataF2[,c("seg.name","seg.po","seg.po.2","CTR","PSP","PiD","CBD","CTE","AD","modification","site")]
  segF.f$seg.Start <- as.character(segF.f$seg.Start)
  segF.f$seg.End <- as.character(segF.f$seg.End)
  segF.annotation <- indataF2[,c(1,2,3,10,11)]

  df <- indata2[,c("modification","AA","seg.po","site")]
  colnames(df) <- c("V1","V2","V3","V5")
  df <- df[order(df$V3),]
  df <- df[!duplicated(df),]
  df <- df[df$V1!="Oxidation",]
  df <- df[df$V1!="Deamidated",]
  df <- df[!(df$V1=="GG"&df$V2=="S"),]
  
  dfC <- indataC2[,c("modification","AA","seg.po","site")]
  colnames(dfC) <- c("V1","V2","V3","V5")
  dfC <- dfC[order(dfC$V3),]
  dfC <- dfC[!duplicated(dfC),]
  
  dfF <- indataF2[,c("modification","seg.po","seg.po.2","site")]
  colnames(dfF) <- c("V1","V2","V3","V5")
  dfF <- dfF[order(dfF$V3),]
  dfF <- dfF[!duplicated(dfF),]
  
  minval <- 0.13
  df$V4 <- rep(minval,dim(df)[1])
  df[!(df$V1%in%c("Phospho")),]$V4 <- -1*minval
  df$V3 <- as.numeric(df$V3)
  df <- df[!(df$V1%in%c("Oxidation")),]
  df <- df[!(df$V1%in%c("Deamidated")),]
  
  dfC$V4 <- rep(minval,dim(dfC)[1])
  dfC$V3 <- as.numeric(dfC$V3)
  
  dfF$V4 <- rep(minval,dim(dfF)[1])
  dfF$V3 <- as.numeric(dfF$V3)
  
  df <- adjustheights_all(df,22,0.1,nophospho=TRUE)
  df <- readjust_reverse_all(df,0.1,minval,nophospho=TRUE)
  
  dfC <- adjustheights_all(dfC,22,0.1,nophospho=TRUE)
  dfC <- readjust_reverse_all(dfC,0.1,minval,nophospho=TRUE)
  
  dfF <- adjustheights_all(dfF,22,0.1,nophospho=TRUE)
  dfF <- readjust_reverse_all(dfF,0.1,minval,nophospho=TRUE)
  
  df2 <- data.frame(x1=c(1,45,74,103,151,242,273,304,335,372),x2=c(45,74,103,151,242,273,304,335,372,441),y1=rep(-0.08,10),y2=rep(0.08,10),colo=c("A","B","B","A","B","B","B","B","B","A"),name=c("","N1","N2","Mid","PRR","R1","R2","R3","R4",""))
  dfC2 <- data.frame(x1=c(1,45,74,103,151,242,273,304,335,372),x2=c(45,74,103,151,242,273,304,335,372,441),y1=rep(-0.08,10),y2=rep(0.08,10),colo=c("A","B","B","A","B","B","B","B","B","A"),name=c("","N1","N2","Mid","PRR","R1","R2","R3","R4",""))
  dfF2 <- data.frame(x1=c(1,45,74,103,151,242,273,304,335,372),x2=c(45,74,103,151,242,273,304,335,372,441),y1=rep(-0.08,10),y2=rep(0.08,10),colo=c("A","B","B","A","B","B","B","B","B","A"),name=c("","N1","N2","Mid","PRR","R1","R2","R3","R4",""))
  
  textsize <- 5
  ratio <- 4/5
  align <- 0.18

  indata2 <- indata2[!(indata2$modification=="GG"&indata2$AA=="S"),]
  
  seg <- data.frame(sectors=c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term"),x=c(1,45,74,103,151,242,273,304,335,372),y=c(44,73,102,150,241,272,303,334,371,441),the.v=c(NA),NO=c(NA))
  df <- data.frame(sectors=character(),x=numeric(),y=numeric())
  for(i in 1:dim(seg)[1]) {
    df.tmp <- data.frame(sectors=rep(seg$sectors[i],length(seg$x[i]:seg$y[i])),x=c(seg$x[i]:seg$y[i]),y=c(seg$x[i]:seg$y[i]))
    df <- rbind(df,df.tmp)
  }
  df$sectors <- factor(df$sectors,levels=seg$sectors)
  indata2.tmp <- indata2
  colnames(indata2.tmp) <- c("sectors","AA","x","CTR","PSP","PiD","CBD","CTE","AD","modification","site")
  df2 <- merge(df,indata2.tmp,all=TRUE)
  df2[is.na(df2$AD),]$AD <- 0
  df2[is.na(df2$CBD),]$CBD <- 0
  df2[is.na(df2$CTR),]$CTR <- 0
  df2[is.na(df2$CTE),]$CTE <- 0
  df2[is.na(df2$PiD),]$PiD <- 0
  df2[is.na(df2$PSP),]$PSP <- 0
  df2$AD <- as.numeric(df2$AD)
  df2$CBD <- as.numeric(df2$CBD)
  df2$CTR <- as.numeric(df2$CTR)
  df2$PiD <- as.numeric(df2$PiD)
  df2$PSP <- as.numeric(df2$PSP)
  df2$CTE <- as.numeric(df2$CTE)

  df2$AA <- NULL
  df3 <- df2[!is.na(df2$site),]
  df3.t <- df3
  if(min_value>0.00) {
    df3.t[df3.t$AD<min_value,]$AD <- 0.0
    df3.t[df3.t$CBD<min_value,]$CBD <- 0.0
    df3.t[df3.t$CTR<min_value,]$CTR <- 0.0
    df3.t[df3.t$PiD<min_value,]$PiD <- 0.0
    df3.t[df3.t$PSP<min_value,]$PSP <- 0.0
    df3.t[df3.t$CTE<min_value,]$CTE <- 0.0
  }
  
  segC <- data.frame(sectors=c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term"),x=c(1,45,74,103,151,242,273,304,335,372),y=c(44,73,102,150,241,272,303,334,371,441),the.v=c(NA),NO=c(NA))
  dfC <- data.frame(sectors=character(),x=numeric(),y=numeric())
  for(i in 1:dim(segC)[1]) {
    dfC.tmp <- data.frame(sectors=rep(segC$sectors[i],length(segC$x[i]:segC$y[i])),x=c(segC$x[i]:segC$y[i]),y=c(segC$x[i]:segC$y[i]))
    dfC <- rbind(dfC,dfC.tmp)
  }
  dfC$sectors <- factor(dfC$sectors,levels=segC$sectors)
  indataC2.tmp <- indataC2
  colnames(indataC2.tmp) <- c("sectors","AA","x","CTR","PSP","PiD","CBD","CTE","AD","modification","site")
  dfC2 <- merge(dfC,indataC2.tmp,all=TRUE)
  dfC2[is.na(dfC2$AD),]$AD <- 0
  dfC2[is.na(dfC2$CBD),]$CBD <- 0
  dfC2[is.na(dfC2$CTR),]$CTR <- 0
  dfC2[is.na(dfC2$CTE),]$CTE <- 0
  dfC2[is.na(dfC2$PiD),]$PiD <- 0
  dfC2[is.na(dfC2$PSP),]$PSP <- 0
  dfC2$AD <- as.numeric(dfC2$AD)
  dfC2$CBD <- as.numeric(dfC2$CBD)
  dfC2$CTR <- as.numeric(dfC2$CTR)
  dfC2$PiD <- as.numeric(dfC2$PiD)
  dfC2$PSP <- as.numeric(dfC2$PSP)
  dfC2$CTE <- as.numeric(dfC2$CTE)
  
  dfC2$AA <- NULL
  dfC3 <- dfC2[!is.na(dfC2$site),]
  dfC3.t <- dfC3
  if(min_value>0.00) {
    dfC3.t[dfC3.t$AD<min_value,]$AD <- 0.0
    dfC3.t[dfC3.t$CBD<min_value,]$CBD <- 0.0
    dfC3.t[dfC3.t$CTR<min_value,]$CTR <- 0.0
    dfC3.t[dfC3.t$PiD<min_value,]$PiD <- 0.0
    dfC3.t[dfC3.t$PSP<min_value,]$PSP <- 0.0
    dfC3.t[dfC3.t$CTE<min_value,]$CTE <- 0.0
  }
  
  segF <- data.frame(sectors=c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term"),x=c(1,45,74,103,151,242,273,304,335,372),y=c(44,73,102,150,241,272,303,334,371,441),the.v=c(NA),NO=c(NA))
  dfF <- data.frame(sectors=character(),x=numeric(),y=numeric())
  for(i in 1:dim(segF)[1]) {
    dfF.tmp <- data.frame(sectors=rep(segF$sectors[i],length(segF$x[i]:segF$y[i])),x=c(segF$x[i]:segF$y[i]),y=c(segF$x[i]:segF$y[i]))
    dfF <- rbind(dfF,dfF.tmp)
  }
  dfF$sectors <- factor(dfF$sectors,levels=segF$sectors)
  indataF2.tmp <- indataF2
  colnames(indataF2.tmp) <- c("sectors","x","x.2","CTR","PSP","PiD","CBD","CTE","AD","modification","site")
  dfF2 <- merge(dfF,indataF2.tmp,all=TRUE)
  dfF2[is.na(dfF2$AD),]$AD <- 0
  dfF2[is.na(dfF2$CBD),]$CBD <- 0
  dfF2[is.na(dfF2$CTR),]$CTR <- 0
  dfF2[is.na(dfF2$CTE),]$CTE <- 0
  dfF2[is.na(dfF2$PiD),]$PiD <- 0
  dfF2[is.na(dfF2$PSP),]$PSP <- 0
  dfF2$AD <- as.numeric(dfF2$AD)
  dfF2$CBD <- as.numeric(dfF2$CBD)
  dfF2$CTR <- as.numeric(dfF2$CTR)
  dfF2$PiD <- as.numeric(dfF2$PiD)
  dfF2$PSP <- as.numeric(dfF2$PSP)
  dfF2$CTE <- as.numeric(dfF2$CTE)
  dfF3 <- dfF2[!is.na(dfF2$site),]
  dfF3.t <- dfF3
  if(min_value>0.00) {
    dfF3.t[dfF3.t$AD<min_value,]$AD <- 0.0
    dfF3.t[dfF3.t$CBD<min_value,]$CBD <- 0.0
    dfF3.t[dfF3.t$CTR<min_value,]$CTR <- 0.0
    dfF3.t[dfF3.t$PiD<min_value,]$PiD <- 0.0
    dfF3.t[dfF3.t$PSP<min_value,]$PSP <- 0.0
    dfF3.t[dfF3.t$CTE<min_value,]$CTE <- 0.0
  }

  df3 <- df3[apply(df3.t[,c(4:9)],1,sum)>0.0,]
  bed <- df3[,c("sectors","x","y","modification","site")]
  colnames(bed) <- c("chr","start","end","modification","site")
  bed <- bed[!is.na(bed$site),]
  bed <- bed[bed$modification%in%c("Phospho","Methyl","GG","Acetyl","Citrullination"),]
  
  dfC3 <- dfC3[apply(dfC3.t[,c(4:9)],1,sum)>0.0,]
  bedC <- dfC3[,c("sectors","x","y","modification","site")]
  colnames(bedC) <- c("chr","start","end","modification","site")
  bedC <- bedC[!is.na(bedC$site),]
  bedC <- bedC[bedC$modification%in%c("Nontryptic"),]
  
  dfF3 <- dfF3[apply(dfF3.t[,c(5:10)],1,sum,na.rm=TRUE)>0.0,]
  dfF3$y <- dfF3$x.2
  dfF3$x.2 <- NULL
  
  bedF <- dfF3[,c("sectors","x","y","modification","site")]
  colnames(bedF) <- c("chr","start","end","modification","site")
  bedF <- bedF[!is.na(bedF$site),]

  col = c("Acetyl"="#93478F","Citrullination"="#FF17E3","Methyl"="#FF7369","Phospho"="#000000","GG"="#7AB77C","Nontryptic"="#9B9B9B")
  bgcol <- c("AD"="#E41A1C","CTR"="#4DAF4A","PiD"="#984EA3","PSP"="#FF7F00","CBD"="#FFD92F","DLB"="#8DD3C7","CTE"="#1740B6","fAD"="#9C0B0C","CAA"="#914B00","NPCAD"="#FF17E3","FTLDTau"="#17DFFF")
  flexi_col <- c("highMod"="#D73027","lowMod"="#4575B4","lowTau"="#C1ACB1FF","highTau"="#50162D","3R"="#23A179","4R"="#256EA1","absence"="#BEBADA","presence"="#E78AC3")
  
  alpha <- 0.1
  selectbordercolor <- function(x) {
    "#000000"
  }
  fact <- c(1.2,1.2,1.2,1.2,1.2)
  fact2 <- c(1,1.5,2,2.5,3)
  
  thicktracks <- 0.06
  thintracks <- 0.01
  m1 <- 0.0025
  m2 <- 0.005
  lwd <- 0.5
  lwd2 <- 2
  lwd3 <- 1
  lty1 <- 1
  lty2 <- 1
  text_x <- 10
  text_y <- 0.5
  facing <- "clockwise"
  labelsize <- 0.6
  
  major_at <- c(1,45,74,103,151,242,273,304,335,372,441)
  major_at <- c(1,50,100,150,200,250,300,350,400,441)
  
  sharedPTM <- function(x) {
    
    norm <- c(24/203,14/203,41/203,20/203,34/203,24/203,46/203)
    
    average <- sum(x * norm)
    
    result <- "unique"
    if(average>=0.6) {
      result <- "shared"
    }
    result
  }
  
  df4 <- df3
  df4$y <- NULL
  df4$shared <- apply(df4[,c(3:8)],1,sharedPTM)
  df4.melt <- melt(df4,id.vars=c("sectors","x","modification","site","shared"))
  df4.melt <- df4.melt[(df4.melt$modification!="Oxidation"),]
  df4.melt <- df4.melt[(df4.melt$modification!="Deamidated"),]
  df4.melt$variable <- as.character(df4.melt$variable)
  
  dfC4 <- dfC3
  dfC4$y <- NULL
  dfC4$shared <- apply(dfC4[,c(3:8)],1,sharedPTM)
  dfC4.melt <- melt(dfC4,id.vars=c("sectors","x","modification","site","shared"))
  dfC4.melt$variable <- as.character(dfC4.melt$variable)
  
  dfF4 <- dfF3
  dfF4$shared <- apply(dfF4[,c(4:9)],1,sharedPTM)
  dfF4.melt <- melt(dfF4,id.vars=c("sectors","x","y","modification","site","shared"))
  dfF4.melt$variable <- as.character(dfF4.melt$variable)
  
  df6 <- data.frame(x1=c(1,45,74,103,151,242,273,304,335,372),x2=c(45,74,103,151,242,273,304,335,372,441),y1=rep(-0.1,10),y2=rep(0.1,10),colo=c("A","B","B","A","B","B","B","B","B","A"),name=c("","N1","N2","Mid","PRR","R1","R2","R3","R4",""),sectors=c("N-term","N1","N2","Mid","PRR","R1","R2","R3","R4","C-term"))

  npdxs <- factor(c("CTR","PSP","PiD","CBD","CTE","AD"),levels=c("CTR","PSP","PiD","CBD","CTE","AD"))
  npdxsF <- npdxs
  npdxsP <- npdxs
  npdxsC <- npdxs
  
  indataP <- read.csv(inpfileP,header=FALSE)
  indataC <- read.csv(inpfileC,header=FALSE)
  indataF <- read.csv(inpfileF,header=FALSE)

  metaP <- indataP[,((indataP[2,]=="")&(indataP[1,]!=""))]
  metaC <- indataC[,((indataC[2,]=="")&(indataC[1,]!=""))]
  metaF <- indataF[,((indataF[2,]=="")&(indataF[1,]!=""))]

  PTMsites <- indataP[1,-c(1,2)]
  Cleavagesites <- indataC[1,-c(1,2)]
  FLEXIsites <- indataF[3,-c(1,2)]
  
  dfP <- as.data.frame(matrix(unlist(lapply(PTMsites,splitPTMs)),ncol=5,byrow=TRUE))
  dfC <- as.data.frame(matrix(unlist(lapply(Cleavagesites,splitPTMs)),ncol=5,byrow=TRUE))
  dfF <- as.data.frame(matrix(unlist(lapply(FLEXIsites,splitFLEXI)),ncol=5,byrow=TRUE))
  
  dfP[dfP$V1=="Iso-2N4R",]$V3 <- 444
  dfP[dfP$V1=="Iso-0N",]$V3 <- 445
  dfP[dfP$V1=="Iso-1N",]$V3 <- 446
  dfP[dfP$V1=="Iso-3R",]$V3 <- 447
  
  dfC[dfC$V1=="Iso-2N4R",]$V3 <- 444
  dfC[dfC$V1=="Iso-0N",]$V3 <- 445
  dfC[dfC$V1=="Iso-1N",]$V3 <- 446
  dfC[dfC$V1=="Iso-3R",]$V3 <- 447
  colnames(dfC) <- colnames(dfP)
  
  dfF[dfF$V1=="TotalTau",]$V3 <- 444
  dfF[dfF$V1=="TotalTau",]$V4 <- 446
  dfF[dfF$V1=="Ratio",]$V1 <- "RisoformRatio"
  dfF[dfF$V1=="RisoformRatio",]$V3 <- 446
  dfF[dfF$V1=="RisoformRatio",]$V4 <- 448
  
  dfP$x1 <- as.numeric(dfP$V3)
  dfP$x2 <- dfP$x1+1
  dfC$x1 <- as.numeric(dfC$V3)
  dfC$x2 <- dfC$x1+1
  dfF$x1 <- as.numeric(dfF$V2)
  dfF$x2 <- as.numeric(dfF$V3)
  
  indataP <- as.data.frame(t(indataP[,-c(1,2)]))
  dfP[dfP$V2=="X",]$V3 <- 0
  dfP$V2 <- paste(dfP$V2,dfP$V3,sep="")
  dfP <- dfP[,c("V1","V2","V5","x1","x2")]
  colnames(dfP) <- c("V2","V3","V4","x1","x2")
  indataP <- merge(dfP,indataP,all=TRUE)
  colnames(indataP) <- c("V1","V2","iso","x1","x2","V3",metaP$V2[-c(1:4)])
  indataP.melt <- melt(indataP,id.vars=c("V1","V2","iso","V3","x1","x2"))
  
  indataC <- as.data.frame(t(indataC[,-c(1,2)]))
  dfC[dfC$V2=="X",]$V3 <- 0
  dfC$V2 <- paste(dfC$V2,dfC$V3,sep="")
  dfC <- dfC[,c("V1","V2","V5","x1","x2")]
  colnames(dfC) <- c("V2","V3","V4","x1","x2")
  indataC <- merge(dfC,indataC,all=TRUE)
  colnames(indataC) <- c("V1","V2","iso","x1","x2","V3",metaC$V2[-c(1:4)])
  indataC.melt <- melt(indataC,id.vars=c("V1","V2","iso","V3","x1","x2"))
  
  indataF <- as.data.frame(t(indataF[,-c(1,2)]))
  indataF$V2 <- substitueSeparators2(indataF$V2)
  dfF$V2 <- paste(dfF$V5,dfF$x1,dfF$x2,sep=".")
  dfF[dfF$V1=="TotalTau",]$V2 <- "2N4R.1.441"
  dfF[dfF$V1=="RisoformRatio",]$V2 <- "4R3R.1.441"
  dfF <- dfF[,c("V1","V2","x1","x2")]
  indataF <- merge(dfF,indataF,all=TRUE)
  colnames(indataF) <- c("V1","V2","x1","x2","V3",metaF$V2[-c(1:3)])
  indataF.melt <- melt(indataF,id.vars=c("V1","V2","V3","x1","x2"))
  
  for(i in 1:length(npdxsP)) {
    npdx <- npdxsP[i]
    tmp <- indataP.melt[indataP.melt$variable==npdx,]
    tmp <- tmp[order(tmp$value,decreasing=TRUE),]
    tmp <- tmp[1:threshold,]$V3
    indataP.melt <- indataP.melt[!(indataP.melt$variable==npdx&(!indataP.melt$V3%in%tmp)),]
  }
  
  indataP.melt$site <- paste(indataP.melt$x1,indataP.melt$x2,sep="-")
  if(sum(indataP.melt$V2=="X0")>0) {
    indataP.melt[indataP.melt$V2=="X0",]$site <- "1-441"
  }
  
  for(i in 1:length(npdxsC)) {
    npdx <- npdxsC[i]
    tmp <- indataC.melt[indataC.melt$variable==npdx,]
    tmp <- tmp[order(tmp$value,decreasing=TRUE),]
    tmp <- tmp[1:threshold,]$V3
    indataC.melt <- indataC.melt[!(indataC.melt$variable==npdx&(!indataC.melt$V3%in%tmp)),]
  }
  
  indataC.melt$site <- paste(indataC.melt$x1,indataC.melt$x2,sep="-")
  if(sum(indataC.melt$V2=="X0")>0) {
    indataC.melt[indataC.melt$V2=="X0",]$site <- "1-441"
  }
  
  for(i in 1:length(npdxsF)) {
    npdx <- npdxsF[i]
    tmp <- indataF.melt[indataF.melt$variable==npdx,]
    tmp <- tmp[order(tmp$value,decreasing=TRUE),]
    tmp <- tmp[1:threshold,]$V3
    indataF.melt <- indataF.melt[!(indataF.melt$variable==npdx&(!indataF.melt$V3%in%tmp)),]
  }
  
  indataF.melt$site <- paste(indataF.melt$x1,indataF.melt$x2,sep="-")
  indataF.melt[indataF.melt$V1=="TotalTau",]$site <- "1-441"
  indataF.melt[indataF.melt$V1=="RisoformRatio",]$site <- "1-441"
  indataF.melt[indataF.melt$V1=="RisoformRatio",]$V1 <- "Ratio"

  df4.melt$newmod <- paste(df4.melt$modification,df4.melt$site,sep="_")
  indataP.melt$newmod <- paste(indataP.melt$V1,indataP.melt$V2,sep="_")
  for(i in 1:length(npdxsP)) {
    npdx <- npdxsP[i]
    tmp <- indataP.melt[indataP.melt$variable==npdx,]
    tmp <- tmp$newmod
    df4.melt[(df4.melt$variable==npdx&(!df4.melt$newmod%in%tmp)&df4.melt$value<=0.1),]$value <- NA
    df4.melt[(df4.melt$variable==npdx&(df4.melt$newmod%in%tmp)),]$shared <- "important"
  }
  
  dfC4.melt$newmod <- paste(dfC4.melt$modification,dfC4.melt$site,sep="_")
  indataC.melt$newmod <- paste(indataC.melt$V1,indataC.melt$V2,sep="_")
  indataC.melt$newmod <- str_replace_all(indataC.melt$newmod,"Non-tryptic","Nontryptic")
  for(i in 1:length(npdxsC)) {
    npdx <- npdxsC[i]
    tmp <- indataC.melt[indataC.melt$variable==npdx,]
    tmp <- tmp$newmod
    dfC4.melt[(dfC4.melt$variable==npdx&(!dfC4.melt$newmod%in%tmp)&dfC4.melt$value<=0.1),]$value <- NA
    dfC4.melt[(dfC4.melt$variable==npdx&(dfC4.melt$newmod%in%tmp)),]$shared <- "important"
  }
  
  tmpset <- c()
  for(i in 1:length(npdxsF)) {
    npdx <- npdxsF[i]
    tmp <- indataF.melt[indataF.melt$variable==npdx,]
    tmpset <- unique(c(tmpset,tmp$V1))
  }
  dfF4.melt[!dfF4.melt$modification%in%tmpset,]$value <- NA

  tmp <- df4.melt$newmod
  for(mod in tmp) {
    if(all(is.na(df4.melt[df4.melt$newmod==mod,]$value))) {
      df4.melt <- df4.melt[df4.melt$newmod!=mod,]
    }
  }
  indataP.melt$newmod <- NULL
  df4.melt$newmod <- NULL
  
  tmp <- dfC4.melt$newmod
  for(mod in tmp) {
    if(all(is.na(dfC4.melt[dfC4.melt$newmod==mod,]$value))) {
      dfC4.melt <- dfC4.melt[dfC4.melt$newmod!=mod,]
    }
  }
  indataC.melt$newmod <- NULL
  dfC4.melt$newmod <- NULL
  
  tmp <- dfF4.melt$modification
  for(mod in tmp) {
    if(all(is.na(dfF4.melt[dfF4.melt$modification==mod,]$value))) {
      dfF4.melt <- dfF4.melt[dfF4.melt$modification!=mod,]
    }
  }

  df4.tmp <- df4.melt[,c("x","modification","site","sectors")]
  df4.tmp <- df4.tmp[!duplicated(df4.tmp),]
  df4.tmp <- df4.tmp[order(df4.tmp$x),]
  df4.tmp$rank <- seq(1,dim(df4.tmp)[1],by=1)
  df4.melt <- merge(df4.melt,df4.tmp,all=TRUE)
  
  dfC4.tmp <- dfC4.melt[,c("x","modification","site","sectors")]
  dfC4.tmp <- dfC4.tmp[!duplicated(dfC4.tmp),]
  dfC4.tmp <- dfC4.tmp[order(dfC4.tmp$x),]
  dfC4.tmp$rank <- seq(1,dim(dfC4.tmp)[1],by=1)
  dfC4.melt <- merge(dfC4.melt,dfC4.tmp,all=TRUE)
  
  dfF4.tmp <- dfF4.melt[,c("x","y","modification","site","sectors")]
  dfF4.tmp <- dfF4.tmp[!duplicated(dfF4.tmp),]
  dfF4.tmp <- dfF4.tmp[order(dfF4.tmp$x,dfF4.tmp$y),]
  dfF4.tmp$rank <- seq(1,dim(dfF4.tmp)[1],by=1)
  dfF4.melt <- merge(dfF4.melt,dfF4.tmp,all=TRUE)

  textsize <- 4
  ratio <- 4/5
  align <- 0.18

  alpha <- 1
  selectbackgroundcolor <- function(x) {
    scales::alpha(bgcol[x],alpha=alpha)
  }
  indent <- 1.5
  
  g_legend<-function(a.gplot){
    tmp <- ggplot_gtable(ggplot_build(a.gplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)
    }

  variable.labs <- c("CTR","PSP","PiD","CBD","CTE","AD")
  names(variable.labs) <- c("CTR","PSP","PiD","CBD","CTE","AD")
  df4.melt$variable <- factor(df4.melt$variable,levels=c("CTR","PSP","PiD","CBD","CTE","AD"))

  variable.labsC <- c("CTR","PSP","PiD","CBD","CTE","AD")
  names(variable.labsC) <- c("CTR","PSP","PiD","CBD","CTE","AD")
  dfC4.melt$variable <- factor(dfC4.melt$variable,levels=c("CTR","PSP","PiD","CBD","CTE","AD"))

  variable.labsF <- c("CTR","PSP","PiD","CBD","CTE","AD")
  names(variable.labsF) <- c("CTR","PSP","PiD","CBD","CTE","AD")
  dfF4.melt$variable <- factor(dfF4.melt$variable,levels=c("CTR","PSP","PiD","CBD","CTE","AD"))

  cleavage_col <- c("N-term"="#607196","C-term"="#A6608B")
  df4.melt <- df4.melt[order(df4.melt$rank),]

  textsize <- 12
  linedist <- 0
  topmargin <- 0.4

  col_fun = colorRamp2(c(1, 0.5, 0), c("#4575B4", "#FFFFBF", "#D73027"))
  taucol <- c("B"="#E6E6E6","A"="#F9F9F9")
  bgcol <- c("AD"="#E41A1C","CTR"="#4DAF4A","PiD"="#984EA3","PSP"="#FF7F00","CBD"="#FFD92F","DLB"="#8DD3C7","CTE"="#1740B6","fAD"="#9C0B0C","CAA"="#914B00","NPCAD"="#FF17E3","FTLDTau"="#17DFFF")
  combcol <- c(taucol,bgcol)
  col = c("Cleavage"="#AAAAAA","Acetyl"="#93478F","GG"="#7AB77C","Methyl"="#FF7369","Phospho"="#000000","Citrullination"="#FF17E3","Deamidated"="#6C7EBC")
  
  ddd <- 0.03
  offset <- 15
  textsize <- 4
  ratio <- 4/5
  align <- 0.03
  multifactor <- 21/3
  df.seq3 <- data.frame(x1=c(-35),x2=c(-5),y1=rep(-ddd,1),y2=rep(ddd,1))
  df.seq4 <- df.seq3
  df.seq <- data.frame(x1=c(1,45,74,103,151,242,273,304,335,372),x2=c(45,74,103,151,242,273,304,335,372,441),y1=rep(-ddd*(2/3),10),y2=rep(ddd*(2/3),10),colo=c("A","B","B","A","B","B","B","B","B","A"),name=c("","N1","N2","","PRR","R1","R2","R3","R4",""))
  df.seq1 <- df.seq
  for(kk in 1:6) {
    df.seq.tmp <- df.seq1
    df.seq.tmp$y1 <- df.seq.tmp$y1 + kk*(multifactor*ddd)
    df.seq.tmp$y2 <- df.seq.tmp$y2 + kk*(multifactor*ddd)
    df.seq <- rbind(df.seq,df.seq.tmp)
    
    df.seq.tmp2 <- df.seq4
    df.seq.tmp2$y1 <- df.seq.tmp2$y1 + kk*(multifactor*ddd)
    df.seq.tmp2$y2 <- df.seq.tmp2$y2 + kk*(multifactor*ddd)
    df.seq3 <- rbind(df.seq3,df.seq.tmp2)
  }
  df.seq <- df.seq[-c(1:10),]
  df.seq3 <- df.seq3[-c(1),]
  df.seq3$colo <- c("AD","CTE","CBD","PiD","PSP","CTR")
  df.seq3$name <- df.seq3$colo
  
  ptmsize <- 5
  cleavsize <- 3
  ptmsize2 <- ptmsize-2.5
  cleavsize2 <- cleavsize-1.5
  alphaval <- 0.7
  offsetptm <- ddd*(3/6)
  offsetcleav <- ddd*(3/6)
  
  df.text <- data.frame(x1=c(170),y1=c(1.4),name=c("PTMs / Cleavages"))
  sharedunique <- c("")
  
  p0 <- ggplot() +
    geom_rect(data=df.seq,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_text(data=df.seq,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3,force=2,force_pull=0.5) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3,force=2,force_pull=0.5) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3,force=2,force_pull=0.5) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3,force=2,force_pull=0.5) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3,force=3,force_pull=0.5) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3,force=3,force_pull=0.5) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3,force=3,force_pull=0.5) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3,force=3,force_pull=0.5) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3,force=2,force_pull=0.5) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3,force=2,force_pull=0.5) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3,force=3,force_pull=0.5) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3,force=3,force_pull=0.5) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3,force=3,force_pull=0.5) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3,force=3,force_pull=0.5) +
    geom_rect(data=df.seq3,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_text(data=df.seq3,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize,fontface="bold",color=c("#FFFFFF","#FFFFFF","#000000","#FFFFFF","#000000","#000000")) +
    
    xlim(-50+offset,442) + theme_void() + theme(legend.position="none") + ylim(2*-ddd,(6+2/3)*multifactor*ddd+3*ddd) +
    scale_fill_manual(values=combcol) +
    scale_color_manual(values=col) +
    geom_text(data=df.text,aes(x=x1,y=y1,label=name),size=textsize*1.5)
  
  dfF4.melt1 <- dfF4.melt
  dfF4.melt1$value <- as.numeric(dfF4.melt1$value)
  dfF4.melttotal <- dfF4.melt1[dfF4.melt1$modification%in%c("TotalTau"),]
  dfF4.melt1 <- dfF4.melt1[!dfF4.melt1$modification%in%c("Ratio","TotalTau"),]

  df.tmp <- df.seq[!duplicated(df.seq[,-c(3,4)]),]
  df.tmp2 <- df.tmp
  for(disease in c("CTR","PSP","PiD","CBD","CTE","AD")) {
    tmp <- df.tmp2
    tmp$variable <- rep(disease,dim(tmp)[1])
    tmp$value <- rep(NA,dim(tmp)[1])
    
    tmp.2 <- dfF4.melt1[dfF4.melt1$variable==disease,]
    for(i in 1:dim(tmp)[1]) {
      tmp.3 <- tmp.2[(tmp.2$x>=tmp$x1[i]&tmp.2$y<=tmp$x2[i])|(tmp.2$x>=tmp$x1[i]&tmp.2$x<=tmp$x2[i])|(tmp.2$y>=tmp$x1[i]&tmp.2$y<=tmp$x2[i]),]
      if(dim(tmp.3)[1]>0) {
        tmp[i,]$value <- mean(tmp.3$value)
      }
    }
    tmp <- tmp[!is.na(tmp$value),]
    if(disease=="CTR") {
      df.tmp <- tmp
    } else {
      df.tmp <- rbind(df.tmp,tmp)
    }
  }
  
  dfF4.melt1 <- df.tmp
  dfF4.melt1$x <- dfF4.melt1$x1
  dfF4.melt1$y <- dfF4.melt1$x2
  dfF4.melt1[!is.na(dfF4.melt1$value) & dfF4.melt1$value>1,]$value <- 1

  df.tmp <- df.seq[!duplicated(df.seq[,-c(3,4)]),]
  df.tmp2 <- df.tmp
  for(disease in c("CTR","PSP","PiD","CBD","CTE","AD")) {
    tmp <- df.tmp2
    tmp$variable <- rep(disease,dim(tmp)[1])
    tmp$value <- rep(NA,dim(tmp)[1])
    
    tmp.2 <- dfF4.melttotal[dfF4.melttotal$variable==disease,]
    for(i in 1:dim(tmp)[1]) {
      tmp.3 <- tmp.2[(tmp.2$x>=tmp$x1[i]&tmp.2$y<=tmp$x2[i])|(tmp.2$x>=tmp$x1[i]&tmp.2$x<=tmp$x2[i])|(tmp.2$y>=tmp$x1[i]&tmp.2$y<=tmp$x2[i]),]
      if(dim(tmp.3)[1]>0) {
        tmp[i,]$value <- mean(tmp.3$value)
      }
    }
    tmp <- tmp[!is.na(tmp$value),]
    if(disease=="CTR") {
      df.tmp <- tmp
    } else {
      df.tmp <- rbind(df.tmp,tmp)
    }
  }
  
  dfF4.melttotal <- df.tmp
  dfF4.melttotal$x <- dfF4.melttotal$x1
  dfF4.melttotal$y <- dfF4.melttotal$x2

  df.text <- data.frame(x1=c(190),y1=c(1.4),name=c("FLEXITau"))
  
  p01 <- ggplot() +
    geom_rect(data=df.seq,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_rect(data=df.seq3,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_text(data=df.seq3,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize,fontface="bold",color=c("#FFFFFF","#FFFFFF","#000000","#FFFFFF","#000000","#000000")) +
    xlim(-50+offset,442) + theme_void() +  ylim(2*-ddd,(6+2/3)*multifactor*ddd+3*ddd) + theme(legend.position="none") +
    scale_fill_manual(values=combcol) +
    new_scale_fill() +
    scale_fill_gradient2(limits=c(0, 1), low="#D73027", mid="#FFFFBF", high="#4575B4", midpoint=0.5, breaks=c(0.0,0.5,1.0), labels=c("100 %","50 %","0 %")) +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="CTR"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(6*multifactor*ddd),ymax=ddd*(2/3)+(6*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="PSP"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(5*multifactor*ddd),ymax=ddd*(2/3)+(5*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="PiD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(4*multifactor*ddd),ymax=ddd*(2/3)+(4*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="CBD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(3*multifactor*ddd),ymax=ddd*(2/3)+(3*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="CTE"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(2*multifactor*ddd),ymax=ddd*(2/3)+(2*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="AD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(1*multifactor*ddd),ymax=ddd*(2/3)+(1*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_text(data=df.seq,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize) +
    geom_text(data=df.text,aes(x=x1,y=y1,label=name),size=textsize*1.5)
    
  dfF4.melttotal <- dfF4.melttotal[dfF4.melttotal$x==1,]
  dfF4.melttotal$value <- log10(dfF4.melttotal$value)

  df.text <- data.frame(x1=c(5),y1=c(1.4),name=c("Total Tau"))
  
  p01total <- ggplot() +
    geom_rect(data=df.seq3,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_text(data=df.seq3,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize,fontface="bold",color=c("#FFFFFF","#FFFFFF","#000000","#FFFFFF","#000000","#000000")) +
    xlim(-50+offset,45) + theme_void() +  ylim(2*-ddd,(6+2/3)*multifactor*ddd+3*ddd) + theme(legend.position="none") +
    scale_fill_manual(values=combcol) +
    new_scale_fill() +
    scale_fill_gradient2(limits=c(1.5, 3.25), low="#4575B4", mid="#FFFFBF", high="#D73027", midpoint=2.375, breaks=c(1.5,2.375,3.25), labels=c("low","medium","high")) +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="CTR"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(6*multifactor*ddd),ymax=ddd*(2/3)+(6*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="PSP"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(5*multifactor*ddd),ymax=ddd*(2/3)+(5*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="PiD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(4*multifactor*ddd),ymax=ddd*(2/3)+(4*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="CBD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(3*multifactor*ddd),ymax=ddd*(2/3)+(3*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="CTE"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(2*multifactor*ddd),ymax=ddd*(2/3)+(2*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="AD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(1*multifactor*ddd),ymax=ddd*(2/3)+(1*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_text(data=df.text,aes(x=x1,y=y1,label=name),size=textsize*1.5)
  
  df.text <- data.frame(x1=c(5),y1=c(1.4),name=c("Total Insoluble Tau"))
  p01total2 <- ggplot() +
    geom_rect(data=df.seq3,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_text(data=df.seq3,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize,fontface="bold",color=c("#FFFFFF","#FFFFFF","#000000","#FFFFFF","#000000","#000000")) +
    xlim(-50+offset,45) + theme_void() +  ylim(3*ddd,(6+2/3)*multifactor*ddd+3*ddd) + theme(legend.position="none") +
    scale_fill_manual(values=combcol) +
    new_scale_fill() +
    scale_fill_gradient2(limits=c(1.5, 3.25), low="#4575B4", mid="#FFFFBF", high="#D73027", midpoint=2.375, breaks=c(1.5,2.375,3.25), labels=c("low","medium","high")) +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="CTR"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(6*multifactor*ddd),ymax=ddd*(2/3)+(6*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="PSP"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(5*multifactor*ddd),ymax=ddd*(2/3)+(5*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="PiD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(4*multifactor*ddd),ymax=ddd*(2/3)+(4*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="CBD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(3*multifactor*ddd),ymax=ddd*(2/3)+(3*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="CTE"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(2*multifactor*ddd),ymax=ddd*(2/3)+(2*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melttotal,!is.na(value)&variable=="AD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(1*multifactor*ddd),ymax=ddd*(2/3)+(1*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_text(data=df.text,aes(x=x1,y=y1,label=name),size=textsize*1.5)
  
  df.shape <- data.frame(x=c(1,2,3,4),y=c(1,2,3,4),Cleavage=c("Feature1","Feature2","Feature3","Feature4"))
  p.shape <- ggplot() + geom_point(data=df.shape,mapping=aes(x=x,y=y,shape=Cleavage),color="black",size=textsize) + scale_shape_manual(values=c(17,2,16,1),name="Feature importance",labels=c("Cleavage site present","Cleavage site absent","PTM site present","PTM site absent")) + theme(legend.position="top",legend.key=element_rect(fill="transparent",color="transparent"),legend.title.position="top") + guides(shape = guide_legend(nrow=2))

  df.shapecolor <- data.frame(x=c(0,1,2,3,4,5),y=c(0,1,2,3,4,5),PTM=c("Cleavage","Acetyl","Citrullination","GG","Methyl","Phospho"))
  p.shapecolor <- ggplot() + geom_point(data=df.shapecolor,mapping=aes(x=x,y=y,color=PTM),size=textsize,shape=15) + scale_color_manual(values=col,name="Feature type",labels=c("Cleavage","Acetylation","Citrullination","Methylation","Phosphorylation","Ubiquitination"),breaks=c("Cleavage","Acetyl","Citrullination","Methyl","Phospho","GG")) + theme(legend.position="top",legend.key=element_rect(fill="transparent",color="transparent"),legend.title.position="top") + guides(colour = guide_legend(nrow=2))
  
  df.FLEXIcolor <- data.frame(x=c(1,2),y=c(0,1),FLEXITau=c(0,1))
  p.FLEXIcolor <- ggplot() + geom_point(data=df.FLEXIcolor,mapping=aes(x=x,y=y,fill=FLEXITau),size=textsize) + scale_fill_gradient2(limits=c(0, 1), low="#4575B4", mid="#FFFFBF", high="#D73027", midpoint=0.5, breaks=c(0.0,0.5,1.0), labels=c("0 %","50 %","100 %"), name="FLEXITau (Extent of modification)") + theme(legend.position="top",legend.title.position="top",legend.key=element_rect(fill="transparent",color="transparent"),legend.key.width = unit(2.3,"lines"))
  
  df.Totalcolor <- data.frame(x=c(1,2),y=c(0,1),TotalTau=c(0,1))
  p.Totalcolor <- ggplot() + geom_point(data=df.Totalcolor,mapping=aes(x=x,y=y,fill=TotalTau),size=textsize) + scale_fill_gradient2(limits=c(0, 1), low="#4575B4", mid="#FFFFBF", high="#D73027", midpoint=0.5, breaks=c(0.0,0.5,1.0), labels=c("low","medium","high"), name="Total Tau Abundance") + theme(legend.position="top",legend.title.position="top",legend.key=element_rect(fill="transparent",color="transparent"),legend.key.width = unit(1.5,"lines"))
  
  pshape_legend<-g_legend(p.shape)
  pshapecolor_legend<-g_legend(p.shapecolor)
  pFLEXIcolor_legend<-g_legend(p.FLEXIcolor)
  pTotalcolor_legend<-g_legend(p.Totalcolor)
  
  layout <- rbind(c(1,1,1,1,1,2,2,2,2,2,3),
                  c(1,1,1,1,1,2,2,2,2,2,3),
                  c(1,1,1,1,1,2,2,2,2,2,3),
                  c(1,1,1,1,1,2,2,2,2,2,3),
                  c(1,1,1,1,1,2,2,2,2,2,3),
                  c(1,1,1,1,1,2,2,2,2,2,3),
                  c(1,1,1,1,1,2,2,2,2,2,3),
                  c(4,4,5,5,5,6,6,6,6,7,7))
  
  diseaseplotsPTM2 <- list() 
  diseaseplotsPTM2[[1]] <- p0
  diseaseplotsPTM2[[2]] <- p01
  diseaseplotsPTM2[[3]] <- p01total
  diseaseplotsPTM2[[4]] <- pshape_legend
  diseaseplotsPTM2[[5]] <- pshapecolor_legend
  diseaseplotsPTM2[[6]] <- pFLEXIcolor_legend
  diseaseplotsPTM2[[7]] <- pTotalcolor_legend
  
  p_total2 <- grid.arrange(grobs=diseaseplotsPTM2,layout_matrix=layout)
  ggsave(fileout,p_total2,device="png",width=18,height=9,units="cm",dpi=600,scale=2)
  
  sharedunique <- c("shared","unique")
  
  df.text <- data.frame(x1=c(200),y1=c(1.4),name=c("PTMs / Cleavages / FLEXITau"))
  p02 <- ggplot() +
    geom_rect(data=df.seq,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_rect(data=df.seq3,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_text(data=df.seq3,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize,fontface="bold",color=c("#FFFFFF","#FFFFFF","#000000","#FFFFFF","#000000","#000000")) +
    xlim(-50+offset,442) + theme_void() +  ylim(3*ddd,(6+2/3)*multifactor*ddd+3*ddd) + theme(legend.position="none") +
    scale_fill_manual(values=combcol) +
    new_scale_fill() +
    scale_fill_gradient2(limits=c(0, 1), low="#D73027", mid="#FFFFBF", high="#4575B4", midpoint=0.5, breaks=c(0.0,0.5,1.0), labels=c("100 %","50 %","0 %")) +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="CTR"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(6*multifactor*ddd),ymax=ddd*(2/3)+(6*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="PSP"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(5*multifactor*ddd),ymax=ddd*(2/3)+(5*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="PiD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(4*multifactor*ddd),ymax=ddd*(2/3)+(4*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="CBD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(3*multifactor*ddd),ymax=ddd*(2/3)+(3*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="CTE"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(2*multifactor*ddd),ymax=ddd*(2/3)+(2*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_rect(data=subset(dfF4.melt1,!is.na(value)&variable=="AD"),mapping=aes(xmin=x,xmax=y,ymin=(-ddd*(2/3))+(1*multifactor*ddd),ymax=ddd*(2/3)+(1*multifactor*ddd),fill=value),color="#AAAAAA") +
    geom_text(data=df.seq,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize) +
    new_scale_fill() +
    scale_fill_manual(values=combcol) +
    new_scale_color() +
    scale_color_manual(values=col) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&shared=="important"&variable=="CTR"),aes(x=x,y=ddd*(2/3)+(6*multifactor*ddd)+(3*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&shared=="important"&variable=="CTR"),aes(x=x,y=-ddd*(2/3)+(6*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&shared=="important"&variable=="PSP"),aes(x=x,y=ddd*(2/3)+(5*multifactor*ddd)+(3*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&shared=="important"&variable=="PSP"),aes(x=x,y=-ddd*(2/3)+(5*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&shared=="important"&variable=="PiD"),aes(x=x,y=ddd*(2/3)+(4*multifactor*ddd)+(3*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&shared=="important"&variable=="PiD"),aes(x=x,y=-ddd*(2/3)+(4*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&shared=="important"&variable=="CBD"),aes(x=x,y=ddd*(2/3)+(3*multifactor*ddd)+(3*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&shared=="important"&variable=="CBD"),aes(x=x,y=-ddd*(2/3)+(3*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&shared=="important"&variable=="CTE"),aes(x=x,y=ddd*(2/3)+(2*multifactor*ddd)+(3*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&shared=="important"&variable=="CTE"),aes(x=x,y=-ddd*(2/3)+(2*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(df4.melt,!is.na(value)&shared%in%sharedunique&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(2*ddd/3)-offsetptm,color=modification),size=ptmsize2,shape=16,alpha=alphaval) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&shared%in%sharedunique&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3)+offsetcleav,color=modification),size=cleavsize2,shape=17,alpha=alphaval) +
    geom_point(data=subset(df4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=16) +
    geom_point(data=subset(df4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(2*ddd/3),color=modification),size=ptmsize,shape=1) +
    geom_text_repel(data=subset(df4.melt,!is.na(value)&shared=="important"&variable=="AD"),aes(x=x,y=ddd*(2/3)+(1*multifactor*ddd)+(3*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=offsetptm*2,direction="x",segment.color="black",segment.alpha=0.3) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value>=0.5&shared=="important"&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=17) +
    geom_point(data=subset(dfC4.melt,!is.na(value)&value<0.5&shared=="important"&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3),color=modification),size=cleavsize,shape=2) +
    geom_text_repel(data=subset(dfC4.melt,!is.na(value)&shared=="important"&variable=="AD"),aes(x=x,y=-ddd*(2/3)+(1*multifactor*ddd)-(2*ddd/3),color=modification,label=site),size=ptmsize-1.5,nudge_y=-(offsetptm*2),direction="x",segment.color="black",segment.alpha=0.3) +
    geom_rect(data=df.seq3,mapping=aes(xmin=x1,xmax=x2,ymin=y1,ymax=y2,fill=colo),color="#AAAAAA") +
    geom_text(data=df.seq3,aes(x=x1+(x2-x1)/2,y=y1+(y2-y1)/2,label=name),size=textsize,fontface="bold",color=c("#FFFFFF","#FFFFFF","#000000","#FFFFFF","#000000","#000000")) +
    geom_text(data=df.text,aes(x=x1,y=y1,label=name),size=textsize*1.5)
    
    layout <- rbind(c(1,1,1,1,1,1,2),
                    c(1,1,1,1,1,1,2),
                    c(1,1,1,1,1,1,2),
                    c(1,1,1,1,1,1,2),
                    c(1,1,1,1,1,1,2))
    
    layout2 <- rbind(c(1,2,3,3,4,4,5))
    
    diseaseplotsPTM22 <- list() 
    diseaseplotsPTM22[[1]] <- p02
    diseaseplotsPTM22[[2]] <- p01total2
    
    diseaseplotsPTM23 <- list()
    diseaseplotsPTM23[[1]] <- ggplot() + theme_void()
    diseaseplotsPTM23[[2]] <- pshape_legend
    diseaseplotsPTM23[[3]] <- pshapecolor_legend
    diseaseplotsPTM23[[4]] <- pFLEXIcolor_legend
    diseaseplotsPTM23[[5]] <- pTotalcolor_legend    
    
    p_total22 <- grid.arrange(grobs=diseaseplotsPTM22,layout_matrix=layout)
    p_total23 <- grid.arrange(grobs=diseaseplotsPTM23,layout_matrix=layout2)
    ggsave(fileout,p_total22,device="pdf",width=19,height=7.5,units="cm",scale=2)
    ggsave(fileout,p_total23,device="pdf",width=19,height=1.5,units="cm",scale=2)
  
}

setwd("C:/Users/Teaching/Documents/GitHub/TauFeaturesDementias/data")
p_legend <- NA

infile <- "PP_INSOL_reformat_combine.csv"
infileC <- "PP_INSOL_reformat_combine_C.csv"
infileF <- "FLEXITau_INSOL_Primary_reformat_combine_reduced_normalized_RFfilter.csv"
fileout <- "Figure5PanelE.pdf"
inpfileP <- "PP_PTM_INSOL_RF_importance.csv"
inpfileC <- "PP_Cleavage_INSOL_RF_importance.csv"
inpfileF <- "FLEXITau_INSOL_Primary_RF_importance.csv"

p_legend <- createFigure1(infile,infileC,infileF,fileout,0.00,5,0.01,inpfileP,inpfileC,inpfileF)
```
