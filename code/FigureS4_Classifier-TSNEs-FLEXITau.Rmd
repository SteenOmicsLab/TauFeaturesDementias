---
title: "Figure S4 Panels B and C - TSNE visualization for primary and secondary cohort FLEXITau data with 11 features"
author: "Christoph N. Schlaffner"
output:
  pdf_document: default
  html_document: default
---
```{r, include=FALSE}
options(stringsAsFactors=FALSE)
library(ggplot2)
library(R.utils)
library(reshape2)
library(circlize)
library(grid)
library(gridExtra)
library(ggpubr)
library(stringr)
library(ggpmisc)

ROCfile_Train <- "INSOL_Primary_Reduced_RF_ROCs.csv"
ROCfile_Test <- "INSOL_Secondary_RF_ROCs.csv"
FLEXIfile_Test <- "FLEXITau_INSOL_Secondary_5Features_TSNE.csv"
FLEXIfile_Train <- "FLEXITau_INSOL_Primary_Reduced_5Features_TSNE.csv"
outfilename <- "FigureS4PanelsCD.pdf"

ROCdata_Train <- read.csv(ROCfile_Train,header=TRUE)
ROCdata_Train$Neuropathology <- factor(ROCdata_Train$Neuropathology,levels=c(c("CTR","PSP","PiD","CBD","AD")))
ROCdata_Test <- read.csv(ROCfile_Test,header=TRUE)
ROCdata_Test$Neuropathology <- factor(ROCdata_Test$Neuropathology,levels=c(c("CTR","PSP","PiD","CBD","AD")))
ROCdata_Train <- ROCdata_Train[order(ROCdata_Train$Neuropathology),]
ROCdata_Test <- ROCdata_Test[order(ROCdata_Test$Neuropathology),]
FLEXIdata_Train <- read.csv(FLEXIfile_Train,header=TRUE)
FLEXIdata_Test <- read.csv(FLEXIfile_Test,header=TRUE)

titlesize <- 12
axistitlesize <- 10
axistextsize <- 10
npdxcols <- c(AD="#E41A1C",CBD="#FFD92F",CTR="#4DAF4A",PiD="#984EA3",PSP="#FF7F00")

newname <- c("Dx","AUC")
tablesize <- 4.5

FLEXItable_Train <- ROCdata_Train[,c("Neuropathology","FLEXITau")]
FLEXItable_Train <- rbind(FLEXItable_Train,data.frame(Neuropathology=(""),FLEXITau=c("")))
colnames(FLEXItable_Train) <- newname
FLEXItable2_Train <- FLEXItable_Train[FLEXItable_Train[,1]%in%c("CBD","CTE","AD"),]
FLEXItable_Train <- FLEXItable_Train[!(FLEXItable_Train[,1]%in%c("CBD","CTE","AD","")),]
FLEXItable2_Train[nrow(FLEXItable2_Train)+1,] <- ""
rownames(FLEXItable2_Train) <- rownames(FLEXItable_Train)
FLEXItable_Train <- cbind(FLEXItable_Train,FLEXItable2_Train)
colnames(FLEXItable_Train) <- c(newname,paste(newname," ",sep=""))
FLEXItable_Train <- tidyr::tibble(x=-10,y=11,tb=list(FLEXItable_Train))
flexi_Train <- ggplot(FLEXIdata_Train,aes(x=x,y=y,color=disease,fill=disease)) +
  stat_ellipse(geom="polygon",alpha=0.05,level=0.65) +
  geom_point() +
  geom_table(data=FLEXItable_Train,aes(x,y,label=tb),table.theme=ttheme_gtminimal,size=tablesize) +
  scale_color_manual(values=npdxcols) +
  scale_fill_manual(values=npdxcols) +
  ggtitle("\nTSNE Disease Distribution\nFLEXITau - Primary Cohort") +
  theme_minimal() +
  xlab("Dimension 1") +
  ylab("Dimension 2") +
  theme(plot.title=element_text(hjust=0.5,size=titlesize,face="bold"),axis.line=element_line(linewidth=1),title=element_text(size=titlesize,face="bold"),axis.ticks=element_line(linewidth=1),axis.title.x=element_text(size=axistitlesize,face="bold"),axis.text=element_text(size=axistextsize,face="bold",color="black"),axis.title.y=element_text(size=axistitlesize,face="bold"),legend.position="none")

flexi_Train.g <- ggplot_gtable(ggplot_build(flexi_Train))
stripl <- which(grepl('panel', flexi_Train.g$layout$name))
fills <- npdxcols[c("CTR","PSP","PiD","CBD","AD")]
textcols <- c("#000000","#000000","#E6E6E6","#000000","#E6E6E6")

for (i in stripl) {
  j <- which(grepl('GRID.gTree', flexi_Train.g$grobs[[i]]$childrenOrder))
  for(k in 1:6) {
    textk <- 8+k
    bgk <- 20+k
    if(k > 3) {
      textk <-  11+k
      bgk <- 23+k
    }
    flexi_Train.g$grobs[[i]]$children[[j]]$children[[1]]$grobs[[textk]]$gp$col <- textcols[k]
    flexi_Train.g$grobs[[i]]$children[[j]]$children[[1]]$grobs[[bgk]]$gp$fill <- fills[k]
  }
}

blank <- grid.rect(gp=gpar(col="white"))


FLEXItable_Test <- ROCdata_Test[,c("Neuropathology","FLEXITau")]
FLEXItable_Test <- rbind(FLEXItable_Test,data.frame(Neuropathology=(""),FLEXITau=c("")))
colnames(FLEXItable_Test) <- newname
FLEXItable2_Test <- FLEXItable_Test[FLEXItable_Test[,1]%in%c("CBD","CTE","AD"),]
FLEXItable_Test <- FLEXItable_Test[!(FLEXItable_Test[,1]%in%c("CBD","CTE","AD","")),]
FLEXItable2_Test[nrow(FLEXItable2_Test)+1,] <- ""
rownames(FLEXItable2_Test) <- rownames(FLEXItable_Test)
FLEXItable_Test <- cbind(FLEXItable_Test,FLEXItable2_Test)
colnames(FLEXItable_Test) <- c(newname,paste(newname," ",sep=""))
FLEXItable_Test <- tidyr::tibble(x=-8,y=15,tb=list(FLEXItable_Test))
flexi_Test <- ggplot(FLEXIdata_Test,aes(x=x,y=y,color=disease,fill=disease)) +
  stat_ellipse(geom="polygon",alpha=0.05,level=0.65) +
  geom_point() +
  geom_table(data=FLEXItable_Test,aes(x,y,label=tb),table.theme=ttheme_gtminimal,size=tablesize) +
  scale_color_manual(values=npdxcols) +
  scale_fill_manual(values=npdxcols) +
  ggtitle("\nTSNE Disease Distribution\nFLEXITau - Secondary Cohort") +
  theme_minimal() +
  xlab("Dimension 1") +
  ylab("Dimension 2") +
  theme(plot.title=element_text(hjust=0.5,size=titlesize,face="bold"),axis.line=element_line(linewidth=1),title=element_text(size=titlesize,face="bold"),axis.ticks=element_line(linewidth=1),axis.title.x=element_text(size=axistitlesize,face="bold"),axis.text=element_text(size=axistextsize,face="bold",color="black"),axis.title.y=element_text(size=axistitlesize,face="bold"),legend.position="none")

flexi_Test.g <- ggplot_gtable(ggplot_build(flexi_Test))
stripl <- which(grepl('panel', flexi_Test.g$layout$name))
fills <- npdxcols[c("CTR","PSP","PiD","CBD","AD")]
textcols <- c("#000000","#000000","#E6E6E6","#000000","#E6E6E6")

for (i in stripl) {
  j <- which(grepl('GRID.gTree', flexi_Test.g$grobs[[i]]$childrenOrder))
  for(k in 1:6) {
    textk <- 8+k
    bgk <- 20+k
    if(k > 3) {
      textk <-  11+k
      bgk <- 23+k
    }
    flexi_Test.g$grobs[[i]]$children[[j]]$children[[1]]$grobs[[textk]]$gp$col <- textcols[k]
    flexi_Test.g$grobs[[i]]$children[[j]]$children[[1]]$grobs[[bgk]]$gp$fill <- fills[k]
  }
}

blank <- grid.rect(gp=gpar(col="white"))



layout <- t(cbind(c(1,2)))
p_total <- grid.arrange(grobs=list(flexi_Train.g,flexi_Test.g),layout_matrix=layout)
ggsave(outfilename,p_total,device="pdf",width=8.26,height=3.18,units="in",scale=1.5)
```
