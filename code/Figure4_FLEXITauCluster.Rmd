---
title: "Figure 4 (and Supplementary Figure S3)"
author: "Christoph N. Schlaffner"
output:
  pdf_document: default
  html_document: default
---
```{r, include=FALSE}
options(stringsAsFactors=FALSE)
library(dendsort)
library(ggplot2)
library(R.utils)
library(stringr)
library(ComplexHeatmap)
library(GetoptLong)
library(dendextend)
library(circlize)
library(ggdendro)

substitueSeparators <- function(x) {
  str_replace_all(str_replace_all(str_replace_all(str_replace_all(str_replace_all(x,"@","."),"\\(","."),"\\)","."),"; ",".."),"-",".")
}

splitPTMs <- function(x) {
  x_split <- unlist(strsplit(x,"_"))
  isoform <- unlist(strsplit(x_split[length(x_split)],"@"))
  isoform <- isoform[1]
  x <- str_replace_all(x,paste("_",isoform,sep=""),"")
  x <- str_replace_all(x,"\\*","")
  x <- substitueSeparators(x)
  x_split <- unlist(strsplit(x,"\\."))
  y <- unlist(x_split)[nchar(unlist(x_split))>=1|!is.na(as.numeric(unlist(x_split)))]
  idxs <- (which(!is.na(as.numeric(y)))+1)
  
  y <- insert(y,idxs,values=rep(x,length(which(!is.na(as.numeric(y))))))
  extseq <- seq(0,length(idxs)-1,by=1)
  idxs <- idxs + extseq + 1
  insert(y,idxs,values=rep(isoform,length(which(!is.na(as.numeric(y))))))
}

splitNames <- function(x) {
  x_split <- unlist(strsplit(x,"_"))
}

pchselect <- function(x) {
  y <- rep(NA,length(x))
  y[x=="Iso"] <- 8
  y
}

callback <- function(hc, ...) {
  dendsort(hc)
}


createplot <- function(FLEXIfile,outfile,group_disease,anno_colors,pg,metadata,anno_names,outfile2,Sampleclustered) {
  PTMdata <- read.table(FLEXIfile,header=FALSE,sep=",")
  PTMdata <- PTMdata[-c(3),]
  addmeta <- PTMdata[,which(PTMdata[1,]%in%c("TotalTau","RisoformRatio"))]
  colnames(addmeta) <- addmeta[1,]
  addmeta <- addmeta[-c(1,2),]
  PTMdata <- PTMdata[,-which(PTMdata[1,]%in%c("TotalTau","RisoformRatio"))]
  PTMdata.sampes <- PTMdata$V1[-c(1,2)]
  metadf <- data.frame(matrix(unlist(lapply(PTMdata.sampes,splitNames)),ncol=2,byrow=TRUE)[,c(1,2)])
  PTMdata$V1 <- c("","",paste(metadf$X1,metadf$X2,sep="_"))
  addmeta$V1 <- c(paste(metadf$X1,metadf$X2,sep="_"))
  rownames(addmeta) <- addmeta$V1
  addmeta$V1 <- NULL
  if(!(group_disease%in%c("ALL"))) {
    PTMdata <- PTMdata[PTMdata$V2%in%c("",group_disease,"CTR"),]
  }

  Isosites <- PTMdata[2,-c(1,2)]
  Peptides <- PTMdata[1,-c(1,2)]
  FLEXIsites <- paste(Peptides,Isosites,sep="_")
  df <- as.data.frame(matrix(unlist(lapply(FLEXIsites,splitPTMs)),ncol=7,byrow=TRUE)[,-c(6,7)])
  df.full <- df
  df$V2 <- as.numeric(df$V2)
  df$V5 <- as.numeric(df$V5)
  df$V0 <- paste(df$V1,"(",df$V4,")@",df$V2,"-",df$V5,sep="")
  df$V6 <- paste("[",df$V2,"-",df$V5,"]",sep="")
  Isosites <- matrix(unlist(lapply(Isosites,function(x){str_split(x,"@")})),ncol=2,byrow=TRUE)[,1]

  PTMdata2 <- PTMdata
  PTMdata2$V2 <- NULL
  tmp.rownames <- PTMdata2$V1[-c(1,2)]
  PTMdata2$V1 <- NULL
  colnames(PTMdata2) <- PTMdata2[1,]
  PTMdata2 <- PTMdata2[-c(1,2),]
  rownames(PTMdata2) <- tmp.rownames
  for(i in 1:dim(PTMdata2)[2]) {
    PTMdata2[,i] <- as.numeric(PTMdata2[,i])
  }
  
  df <- df[order(df$V2,df$V5),]
  PTMdata2 <- PTMdata2[,df$V1]
  PTMdata2 <- as.matrix(PTMdata2)
  colnames(PTMdata2) <- df$V6
  metadata <- metadata[rownames(metadata)%in%rownames(PTMdata2),]
  addmeta <- addmeta[rownames(addmeta)%in%rownames(PTMdata2),]
  df$Isoform <- df$V4
  df[df$V4=="4R*",]$V6 <- paste(df[df$V4=="4R*",]$V6,"*",sep="")
  rownames(df) <- df$V6
  df[df$Isoform=="4R*",]$Isoform <- ""
  df[df$Isoform=="4R",]$Isoform <- ""
  df[df$Isoform=="0N",]$Isoform <- "Iso"
  df[df$Isoform=="1N",]$Isoform <- "Iso"
  df[df$Isoform=="2N",]$Isoform <- ""
  df[df$Isoform=="2N4R",]$Isoform <- ""
  df[df$Isoform=="",]$Isoform <- NA
  df$V1 <- NULL
  df$V2 <- NULL
  df$V3 <- NULL
  df$V4 <- NULL
  df$V5 <- NULL
  df$V6 <- NULL
  df$V0 <- NULL

  distsample <- dist(as.matrix(PTMdata2),method="euclidean", diag=TRUE, upper=TRUE)
  clustersample <- hclust(distsample,method="ward.D")
    
  sampledendr <- dendro_data(callback(clustersample),type="rectangle")
  sampleclusterdend <- ggplot() + 
  geom_segment(data=segment(sampledendr),aes(x=x,y=y,xend=xend,yend=yend)) + 
    geom_text(data=label(sampledendr),aes(x,y,label=label,hjust=0),angle=-90) + 
    scale_y_continuous(limits=c(-55,120)) +
    theme(axis.line=element_blank(),axis.ticks=element_blank(),axis.text=element_blank(),axis.title=element_blank(),panel.background=element_rect(fill="white"),panel.grid=element_blank())
    
  ggsave(str_replace_all(Sampleclustered,".csv",".png"),sampleclusterdend,width=70,height=15,units="cm")
    
  distPTMsite <- dist(t(as.matrix(PTMdata2)),method="euclidean", diag=TRUE, upper=TRUE)
  clusterPTMsite <- hclust(distPTMsite,method="ward.D")
      
  distPTMsite_f <- as.matrix(dist(t(as.matrix(PTMdata2)),method="euclidean", diag=TRUE, upper=TRUE))
  row <- seq(1,dim(distPTMsite_f)[1],by=1)
  for(i in 1:dim(distPTMsite_f)[1]) {
    distPTMsite_f[i,] <- abs(row-i)
  }
  distPTMsite_f <- as.dist(distPTMsite_f)
  clusterPTMsite_f <- hclust(distPTMsite_f,method="ward.D")
      
  addmeta$TotalTau <- as.numeric(addmeta$TotalTau)
  addmeta$TotalTau <- log10(addmeta$TotalTau)
  addmeta$RisoformRatio <- as.numeric(addmeta$RisoformRatio)
  addmeta$Rratio <- log10(addmeta$RisoformRatio)
  addmeta$RisoformRatio <- NULL
  addmeta$NPDX1 <- metadata$NPDX1
  addmeta$Isoform <- metadata$Isoform
  addmeta$Braak <- metadata$Braak
  addmeta$x <- rep(NA,dim(addmeta)[1])
  addmeta <- addmeta[,c("x","TotalTau","Braak","NPDX1")]
      
  col_fun = colorRamp2(c(1, 0.5, 0), c("#4575B4", "#FFFFBF", "#D73027"))
  col_fun2 = colorRamp2(c(0, max(addmeta$TotalTau)), c("#F2F2F2", "#50162D"))
  col_fun4 = colorRamp2(c(1, length(df$Isoform)), c("#FFFFFF", "#FFFFFF"))
      
  anno_colors <- list(x=c(`NA`="#FFFFFF"),
                      NPDX1=anno_colors$NPDX1,
                      Isoform=anno_colors$Isoform,
                      TotalTau=col_fun2,
                      Braak=anno_colors$Braak
  )

  print(dim(PTMdata2))
  pdffactor <- 4.8
  #pdffactor <- 1
  legendtextsize <- 48/pdffactor
  annotationtextsize <- 48/pdffactor
  annotationtextsizeoffset <- 6/pdffactor
  columngapsize <- 35/pdffactor
  rectlwd <- 2/pdffactor
  dendlwd <- 3/pdffactor
  dendwidth <- 4/pdffactor
  rowfontsize <- 14/pdffactor
  gapneuro <- 8/pdffactor
  maxlegendwidth <- 60/pdffactor
  gridwidth <- 15/pdffactor
  legendwidth <- 13/pdffactor
  simpleannosize <- 18/pdffactor
  gridheight <- 1/pdffactor
  rowgapsize <- 3/pdffactor
  rowgapsize2 <- 4/pdffactor
  titlegapsize <- 2/pdffactor
  annogapsize <- (1/pdffactor)/4
      
  npdx <- c("AD","CBD","CTE","CTRL","DLB","PiD","PSP")
  mods <- c("Acetylation","Citrullination","Deamidation","Methylation","Phosphorylation","Ubiquitination")
  heatmaplegend <- Legend(at=1:2,title=gt_render("**Modification presence**"),labels=c("not detected","detected"),legend_gp=gpar(fill=c("#CCCCCC","#C96328")),title_gp=gpar(fontsize=legendtextsize),labels_gp=gpar(fontsize=legendtextsize))
  ptmlegend <- Legend(at=1:6,title=gt_render("**Modification identity**"),labels=mods,legend_gp=gpar(fill=anno_colors$PTMs[mods]),title_gp=gpar(fontsize=legendtextsize),labels_gp=gpar(fontsize=legendtextsize))
  isoformlegend <- Legend(at=1:5,title=gt_render("**Isoform**"),labels=c("0N","1N","2N","3R","4R"),legend_gp=gpar(fill=anno_colors$Isoform[c("N0","N1","N2","R3","R4")]),title_gp=gpar(fontsize=legendtextsize),labels_gp=gpar(fontsize=legendtextsize))
  Neuropathlegend <- Legend(at=1:8,nrow=1,gap=unit(gapneuro,"mm"),title_gap=unit(titlegapsize,"mm"),grid_width=unit(gridwidth, "mm"),title=gt_render("**Neuropathology***(primary: NPDX)*"),labels=anno_names$NPDX1[npdx],legend_gp=gpar(fill=anno_colors$NPDX1[npdx]),title_gp=gpar(fontsize=legendtextsize),labels_gp=gpar(fontsize=legendtextsize))
      
  Braaklegend <- Legend(at=1:11,title=gt_render("**Braak stage**"),nrow=1,gap=unit(titlegapsize,"mm"),title_gap=unit(titlegapsize,"mm"),grid_width=unit(gridwidth, "mm"),grid_height=unit(gridwidth, "mm"),labels=c("0","0-I","I","II","II-III","III","IV","IV-V","V","V-VI","VI"),legend_gp=gpar(fill=anno_colors$Braak[c("O","OI","I","II","IIIII","III","IV","IVV","V","VVI","VI")]),title_gp=gpar(fontsize=legendtextsize),labels_gp=gpar(fontsize=legendtextsize))
  CTElegend <- Legend(at=1:4,title=gt_render("**CTE stage**"), labels=c("I","II","III","IV"),legend_gp=gpar(fill=anno_colors$CTE[c("I","II","III","IV")]),title_gp=gpar(fontsize=legendtextsize),labels_gp=gpar(fontsize=legendtextsize))
  heatmaplegend <- Legend(col_fun=col_fun,title =gt_render("<br>**Modification extent**"),gap=unit(titlegapsize,"mm"),title_gap=unit(titlegapsize,"mm"),legend_width=unit(legendwidth,"cm"),grid_height=unit(gridheight,"cm"),at=c(1,0.5,0),labels=c("0%","50%","100%"),title_gp=gpar(fontsize=legendtextsize),labels_gp=gpar(fontsize=legendtextsize),direction = "horizontal")
  totaltaumaplegend <- Legend(col_fun=col_fun2,title =gt_render("<br>**Total tau [fmol/mg]**"),legend_width=unit(legendwidth,"cm"),labels=expression(paste("10"^"0"),paste("10"^"1"),paste("10"^"2"),paste("10"^"3"),paste("10"^"4")),gap=unit(titlegapsize,"mm"),title_gap=unit(titlegapsize,"mm"),grid_height=unit(gridheight,"cm"),title_gp=gpar(fontsize=legendtextsize),labels_gp=gpar(fontsize=legendtextsize),direction = "horizontal")
  pd <- packLegend(heatmaplegend,totaltaumaplegend,Braaklegend,Neuropathlegend,max_width=unit(maxlegendwidth,"cm"),direction="horizontal",column_gap=unit(columngapsize,"mm"),row_gap=unit(rowgapsize,"mm"))
      
  pdf(qq(outfile), width = 4.33, height = 10)
  #png(qq(outfile), width =3500, height = 1200, unit = "px")
  htm <- Heatmap(PTMdata2, col=col_fun,rect_gp=gpar(col="white",lwd=rectlwd),
          cluster_rows=set(rev(as.dendrogram(callback(clustersample))),"branches_lwd",dendlwd), cluster_columns=set(as.dendrogram(callback(clusterPTMsite)),"branches_lwd",dendlwd),
          show_column_names=T, row_dend_reorder=FALSE, row_split=6, use_raster=TRUE, raster_device="png", row_dend_width=unit(dendwidth, "cm"),
          show_row_names=F, column_dend_height=unit(dendwidth, "cm"), row_names_gp=gpar(fontsize=rowfontsize),column_names_gp=gpar(fontsize=annotationtextsize), row_title=NULL, row_gap=unit(rowgapsize,"mm"),
          right_annotation=HeatmapAnnotation(df=addmeta,which="row",gap=unit(annogapsize,"points"),col=anno_colors,na_col="white",gp=gpar(col="white"),annotation_label=c("x","Total tau","Braak","NPDX"),annotation_name_gp=gpar(fontsize=annotationtextsize,col=c("white",rep("black",3))),simple_anno_size = unit(simpleannosize,"mm"),annotation_name_side="bottom",show_legend=FALSE),
          left_annotation=HeatmapAnnotation(border=FALSE,foo=anno_block(gp=gpar(fill=anno_colors$NPDX1[c("CTRL","PiD","PSP","CBD","CTE","AD")]),labels=c("F1\nCTR-like", "F2\nPiD-like", "F3\nPSP-like","F4\nCBD-like","F5\nCTE-like","F6\nAD-like"),labels_gp=gpar(col=c("black","white","black","black","white","white"),fontsize=annotationtextsize+annotationtextsizeoffset)),which="row"),
          show_heatmap_legend=FALSE)

  draw(htm,annotation_legend_list=pd,annotation_legend_side="bottom")
  dev.off()
      
  pdf(qq(outfile2), width = 4.33, height = 10)
  #png(qq(outfile2), width =3500, height = 1200, unit = "px")
  htm <- Heatmap(PTMdata2, col=col_fun,rect_gp=gpar(col="white",lwd=rectlwd),
                 cluster_rows=set(rev(as.dendrogram(callback(clustersample))),"branches_lwd",dendlwd), cluster_columns=FALSE,
                 show_column_names=T, row_dend_reorder=FALSE, row_split=6, use_raster=TRUE, raster_device="png", row_dend_width=unit(dendwidth, "cm"),
                 show_row_names=F, column_dend_height=unit(dendwidth, "cm"), row_names_gp=gpar(fontsize=rowfontsize),column_names_gp=gpar(fontsize=annotationtextsize), row_title=NULL, row_gap=unit(rowgapsize,"mm"),
                 right_annotation=HeatmapAnnotation(df=addmeta,which="row",gap=unit(annogapsize,"points"),col=anno_colors,na_col="white",gp=gpar(col="white"),annotation_label=c("","Total tau","Braak","NPDX"),annotation_name_gp=gpar(fontsize=annotationtextsize,col=c("white",rep("black",3))),simple_anno_size = unit(simpleannosize, "mm"),annotation_name_side="bottom",show_legend=FALSE),
                 left_annotation=HeatmapAnnotation(border=FALSE,foo=anno_block(gp=gpar(fill=anno_colors$NPDX1[c("CTRL","PiD","PSP","CBD","CTE","AD")]),labels=c("F1\nCTR-like", "F2\nPiD-like", "F3\nPSP-like","F4\nCBD-like","F5\nCTE-like","F6\nAD-like"),labels_gp=gpar(col=c("black","white","black","black","white","white"),fontsize=annotationtextsize+annotationtextsizeoffset)),which="row"),
                 show_heatmap_legend=FALSE)
  draw(htm,annotation_legend_list=pd,annotation_legend_side="bottom")
  dev.off()
}


anno_colors <- list(Isoform=c(N0="#BEBADA",N1="#FDB462",N2="#F781BF",R3="#66C2A5",R4="#80B1D3",R3R4="#FFCC99",Iso="#000000",`Iso*`="#000000",`Iso**`="#000000","#FFFFFF"),
                    NPDX1=c(fAD="#9C0B0C",AD="#E41A1C",CBD="#FFD92F",CTE="#1740B6",CTRL="#4DAF4A",DLB="#8DD3C7",PiD="#984EA3",PSP="#FF7F00","#FFFFFF"),
                    NPDX2=c(fAD="#9C0B0C",AD="#E41A1C",CBD="#FFD92F",CTE="#1740B6",CTRL="#4DAF4A",DLB="#8DD3C7",PiD="#984EA3",PSP="#FF7F00","#FFFFFF"),
                    Braak=c(O="#F5E8ED",OI="#EBD2DC",I="#E2BCCB",II="#D8A6BA",IIIII="#CF90A9",III="#C57A98",IV="#BC6487",IVV="#B24E76",V="#A93865",VVI="#9F2254",VI="#960C43","#FFFFFF"),
                    CTE=c(I="#C1CAE4",II="#8395C9",III="#4660AE",IV="#092C94","#FFFFFF")
                    )


anno_names <- list(NPDX1=c(fAD="Familial AD",AD="AD",CBD="CBD",CTE="CTE",CTRL="CTR",DLB="DLB",PiD="PiD",PSP="PSP","#FFFFFF"))

metafile <- "INSOL_Primary_Demographics.csv"
metadata <- read.csv(metafile)
rownames(metadata) <- metadata$Sample
metadata$Sample <- NULL
colnames(metadata) <- c("Group","BrainBank","BioID","Age","Sex","PMI","Braak","NPDX1","NPDX2")

NPDXtab <- as.data.frame(table(c(metadata$NPDX1,metadata$NPDX2)))
NPDXtab.filter <- NPDXtab[NPDXtab$Freq>=3,]
NPDXtab.filter$Var1 <- as.character(NPDXtab.filter$Var1)
metadata <- metadata[,c("NPDX1","NPDX2","Braak")]
if(sum(!(metadata$NPDX1%in%NPDXtab.filter$Var1))>0) {
  metadata[!(metadata$NPDX1%in%NPDXtab.filter$Var1),]$NPDX1 <- ""
}
if(sum(!(metadata$NPDX2%in%NPDXtab.filter$Var1))>0) {
  metadata[!(metadata$NPDX2%in%NPDXtab.filter$Var1),]$NPDX2 <- ""
}
metadata[metadata$NPDX2=="",]$NPDX2 <- NA
metadata[metadata$Braak=="",]$Braak <- NA
removedsamples <- c("AD_17","AD_24","CBD_17","CTE_11","CTRL_16","PiD_10","PiD_15","PiD_16","PSP_15","PSP_38")
metadata <- metadata[!(rownames(metadata)%in%removedsamples),]

infileFLEXI <- "FLEXITau_INSOL_Primary_reformat_combine_reduced_normalized.csv"
outfileExtra <- "Figure4_clustered.pdf"
outfileFig4 <- "Figure4.pdf"
outfileClusters <- "INSOL_Primary_FLEXITau_clustered.csv"
  
createplot(infileFLEXI,outfileExtra,"ALL",anno_colors,FALSE,metadata,anno_names,outfileFig4,outfileClusters)
